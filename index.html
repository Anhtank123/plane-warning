<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="color-scheme" content="dark" />
  
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data: https://upload.wikimedia.org; media-src 'self' blob: https://upload.wikimedia.org; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">

  <title>AERO•PORTAL — Cabin Safety + Premium IFE (v3 Patched)</title>

  <style>
    /* --- GIỮ NGUYÊN TOÀN BỘ CSS CỦA BẠN --- */
    :root{
      --bg0:#06070b;
      --bg1:#0a0d16;
      --ink:#e9eefc;
      --muted:#a9b3d6;
      --dim:#6f7aa8;
      --line:rgba(255,255,255,.10);
      --glass:rgba(255,255,255,.06);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 35px rgba(0,0,0,.40);
      --radius: 22px;
      --radius2: 16px;
      --ok:#6ee7b7;
      --warn:#fbbf24;
      --danger:#fb7185;
      --critical:#f43f5e;
      --accent:#8b5cf6;
      --accent2:#22d3ee;
      --focus: 0 0 0 3px rgba(139,92,246,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    /* ===== THEME DARK (Default) ===== */
    :root{ color-scheme: dark; }
    :root[data-theme="dark"]{ color-scheme: dark; }

    /* ========================================================
       APPLE-LIKE LIGHT THEME OVERRIDES (State-of-the-Art)
       ======================================================== */
    :root[data-theme="light"] {
      color-scheme: light;

      /* Core Apple Colors */
      --bg0: #FBFBFD; /* Classic Apple Off-White */
      --bg1: #F5F5F7; /* Classic Apple Gray Background */
      --ink: #1D1D1F; /* Signature Apple Dark Text */
      --muted: #86868B;
      --dim: #A1A1A6;

      /* Glass & Surfaces */
      --glass: rgba(255, 255, 255, 0.65);
      --glass-solid: rgba(255, 255, 255, 0.95);
      --surface-track: rgba(0, 0, 0, 0.05);
      --surface-thumb: #FFFFFF;

      /* Delicate Apple Borders & Shadows */
      --line: rgba(0, 0, 0, 0.08);
      --border-glass: rgba(0, 0, 0, 0.05);
      --inner-glow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      --shadow-apple-soft: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
      --shadow-apple-card: 0 4px 14px -4px rgba(0, 0, 0, 0.06);
      --shadow-apple-float: 0 20px 60px -15px rgba(0, 0, 0, 0.12);

      --focus: 0 0 0 4px rgba(0, 125, 250, 0.25); /* Apple Focus Blue */
    }

    /* Background Gradient Tuning (Ultra Soft) */
    :root[data-theme="light"] body {
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(139, 92, 246, 0.05), transparent 60%),
        radial-gradient(900px 700px at 80% 25%, rgba(34, 211, 238, 0.05), transparent 55%),
        radial-gradient(800px 700px at 55% 80%, rgba(251, 191, 36, 0.03), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* Force Light Mode Text Color Override for Hardcoded White Text */
    :root[data-theme="light"] .brand h1,
    :root[data-theme="light"] .panelHeader h2,
    :root[data-theme="light"] .stageTop h2,
    :root[data-theme="light"] .value,
    :root[data-theme="light"] .v,
    :root[data-theme="light"] .n,
    :root[data-theme="light"] strong,
    :root[data-theme="light"] .callout b,
    :root[data-theme="light"] .step.on,
    :root[data-theme="light"] .svcName,
    :root[data-theme="light"] h3,
    :root[data-theme="light"] .modalTop h3 {
      color: var(--ink) !important;
    }

    /* Fix SVG strokes inside buttons for Light Mode */
    :root[data-theme="light"] .tabicon path { stroke: var(--ink); }
    :root[data-theme="light"] .tabicon path[fill] { fill: var(--ink); stroke: none; }
    :root[data-theme="light"] .logo svg path[fill="rgba(255,255,255,.92)"] { fill: #ffffff; }

    /* Frosted Glass Panels & Modals */
    :root[data-theme="light"] .topbar,
    :root[data-theme="light"] .panel,
    :root[data-theme="light"] .modal,
    :root[data-theme="light"] .svcModal,
    :root[data-theme="light"] .overlayAlert {
      background: var(--glass);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid var(--border-glass);
      box-shadow: var(--shadow-apple-soft), var(--inner-glow);
    }

    /* Remove excessive pseudo-element noise in light mode */
    :root[data-theme="light"] .topbar::before,
    :root[data-theme="light"] .panel::before,
    :root[data-theme="light"] .appTile::before,
    :root[data-theme="light"] .svcCard::before,
    :root[data-theme="light"] .projCard::before {
      opacity: 0;
    }

    /* Solid White Cards with soft shadow */
    :root[data-theme="light"] .card,
    :root[data-theme="light"] .appTile,
    :root[data-theme="light"] .svcCard,
    :root[data-theme="light"] .projCard,
    :root[data-theme="light"] .navItem {
      background: var(--glass-solid);
      border: 1px solid var(--border-glass);
      box-shadow: var(--shadow-apple-card), var(--inner-glow);
    }
    :root[data-theme="light"] .svcCard:hover,
    :root[data-theme="light"] .appTile:hover,
    :root[data-theme="light"] .navItem:hover {
      background: #FFFFFF;
      box-shadow: var(--shadow-apple-float);
    }

    /* Inputs, Textareas, Drops */
    :root[data-theme="light"] input,
    :root[data-theme="light"] select,
    :root[data-theme="light"] textarea,
    :root[data-theme="light"] .svcNote,
    :root[data-theme="light"] .searchBox,
    :root[data-theme="light"] .drop {
      background: rgba(0, 0, 0, 0.03);
      border: 1px solid rgba(0, 0, 0, 0.08);
      color: var(--ink);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.02);
    }
    :root[data-theme="light"] input::placeholder,
    :root[data-theme="light"] textarea::placeholder,
    :root[data-theme="light"] .svcNote::placeholder {
      color: var(--dim);
    }

    /* Segmented Controls & Tabs (iOS Style) */
    :root[data-theme="light"] .tabs,
    :root[data-theme="light"] .seg {
      background: var(--surface-track);
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    :root[data-theme="light"] .tabbtn[data-active="true"],
    :root[data-theme="light"] .seg button[aria-pressed="true"] {
      background: var(--surface-thumb);
      color: var(--ink) !important;
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12), 0 1px 1px rgba(0,0,0,0.04);
    }
    :root[data-theme="light"] .tabbtn:hover:not([data-active="true"]),
    :root[data-theme="light"] .seg button:hover:not([aria-pressed="true"]) {
      background: rgba(0, 0, 0, 0.03);
      color: var(--ink);
    }

    /* Buttons */
    :root[data-theme="light"] .btn,
    :root[data-theme="light"] .svcBtn,
    :root[data-theme="light"] .qtyBtn,
    :root[data-theme="light"] .ovToggle,
    :root[data-theme="light"] .linkBtn {
      background: #FFFFFF;
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: var(--ink);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    :root[data-theme="light"] .btn:hover,
    :root[data-theme="light"] .svcBtn:hover,
    :root[data-theme="light"] .linkBtn:hover {
      background: #F5F5F7;
    }
    /* Primary buttons (keep colorful gradient, ensure text is pure white) */
    :root[data-theme="light"] .btn.primary,
    :root[data-theme="light"] .svcBtn.primary,
    :root[data-theme="light"] .cartPillBtn {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.85), rgba(34, 211, 238, 0.85));
      color: #FFFFFF !important;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    /* Pills, Tags, Chips, Steps */
    :root[data-theme="light"] .pill,
    :root[data-theme="light"] .tag,
    :root[data-theme="light"] .chip,
    :root[data-theme="light"] .step,
    :root[data-theme="light"] .badge,
    :root[data-theme="light"] .fp,
    :root[data-theme="light"] .svcPill {
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.06);
      color: var(--ink);
      backdrop-filter: blur(10px);
      box-shadow: none;
    }
    :root[data-theme="light"] .step.on {
       background: #ffffff;
       box-shadow: 0 2px 6px rgba(0,0,0,0.08);
       border-color: rgba(0,0,0,0.08);
    }
    :root[data-theme="light"] .fp[aria-pressed="true"] {
      background: #ffffff;
      color: var(--ink);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-color: rgba(0,0,0,0.08);
    }

    /* Internal Borders/Dividers */
    :root[data-theme="light"] .panelHeader,
    :root[data-theme="light"] .stageTop,
    :root[data-theme="light"] .modalTop,
    :root[data-theme="light"] .svcModalTop,
    :root[data-theme="light"] .svcModalLeft,
    :root[data-theme="light"] .modalNav {
      border-color: rgba(0, 0, 0, 0.06);
    }
    :root[data-theme="light"] .hr {
      background: rgba(0, 0, 0, 0.06);
    }

    /* Misc Apple Adjustments */
    :root[data-theme="light"] .kpi,
    :root[data-theme="light"] .mutedBox,
    :root[data-theme="light"] .callout {
      background: rgba(0, 0, 0, 0.02);
      border: 1px solid rgba(0, 0, 0, 0.06);
      color: var(--muted);
    }
    :root[data-theme="light"] .svcThumb,
    :root[data-theme="light"] .svcBigThumb {
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    :root[data-theme="light"] video {
      background: #000;
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: var(--shadow-apple-card);
    }
    :root[data-theme="light"] .modalMask,
    :root[data-theme="light"] .svcMask {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    :root[data-theme="light"] .fx {
      opacity: 0.15; /* Tone down background FX */
    }

    /* ========================================================
       GLOBAL / DARK MODE RULES (Your original untouched)
       ======================================================== */
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--ink);
      background:
        radial-gradient(1200px 800px at 20% 20%, rgba(139,92,246,.22), transparent 60%),
        radial-gradient(900px 700px at 80% 25%, rgba(34,211,238,.18), transparent 55%),
        radial-gradient(800px 700px at 55% 80%, rgba(251,191,36,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .fx{
      pointer-events:none;
      position:fixed; inset:0;
      background:
        radial-gradient(600px 400px at 50% 40%, rgba(255,255,255,.08), transparent 60%),
        repeating-linear-gradient(0deg, rgba(255,255,255,.02) 0 1px, transparent 1px 3px);
      mix-blend-mode: overlay;
      opacity:.35;
      filter: blur(.3px);
      animation: fxShift 10s ease-in-out infinite alternate;
    }
    @keyframes fxShift{
      from{ transform: translate3d(0,0,0); opacity:.25; }
      to  { transform: translate3d(0,-10px,0); opacity:.40; }
    }

    .app{
      position:relative;
      height:100%;
      display:flex;
      flex-direction:column;
      padding: 18px;
      gap: 14px;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap: 14px;
      padding: 14px 16px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }
    .topbar::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(800px 150px at 18% 0%, rgba(139,92,246,.30), transparent 60%),
                  radial-gradient(700px 200px at 80% 0%, rgba(34,211,238,.22), transparent 60%);
      opacity:.65;
      pointer-events:none;
    }
    .brand{
      position:relative;
      display:flex; align-items:center; gap: 12px;
      min-width: 280px;
      cursor: default;
    }
    .logo{
      width: 44px; height:44px;
      border-radius: 14px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(139,92,246,.95), rgba(34,211,238,.65));
      box-shadow: 0 14px 30px rgba(0,0,0,.40);
      border: 1px solid rgba(255,255,255,.20);
    }
    .brand h1{
      margin:0;
      font-size: 14px;
      letter-spacing: .20em;
      text-transform: uppercase;
      color: rgba(233,238,252,.92);
    }
    .brand .sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.02em;
    }

    .meta{
      position:relative;
      display:flex;
      align-items:center;
      gap: 10px;
      margin-left:auto;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex; align-items:center; gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      min-height: 40px;
    }
    .pill strong{
      font-family: var(--mono);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .02em;
    }
    .pill span{ color: var(--muted); font-size: 12px; }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(110,231,183,.12);
    }

    .tabs{
      display:flex;
      gap: 10px;
      position:relative;
      padding: 6px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      max-width: 820px;
      margin-left: 10px;
      overflow:hidden;
    }
    .tabbtn{
      appearance:none; border:0; cursor:pointer;
      color: var(--muted);
      background: transparent;
      padding: 12px 14px;
      border-radius: 999px;
      display:flex; align-items:center; gap: 10px;
      font-weight: 750;
      letter-spacing:.02em;
      transition: transform .18s ease, background .18s ease, color .18s ease;
      outline:none;
      min-width: 210px;
      justify-content:center;
    }
    .tabbtn:focus-visible{ box-shadow: var(--focus); }
    .tabbtn:hover{ transform: translateY(-1px); color: var(--ink); }
    .tabbtn[data-active="true"]{
      color: rgba(233,238,252,.98);
      background: linear-gradient(135deg, rgba(139,92,246,.35), rgba(34,211,238,.20));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 40px rgba(139,92,246,.18);
    }
    .tabicon{ width: 18px; height:18px; display:inline-block; opacity:.95; }

    .view{ flex: 1; display:none; min-height: 0; }
    .view.active{ display:flex; }

    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 1.10fr 1.60fr 1.10fr;
      gap: 14px;
      min-height:0;
    }
    .panel{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
      min-height:0;
    }
    .panel::before{
      content:"";
      position:absolute; inset:-1px;
      background:
        radial-gradient(600px 250px at 20% 0%, rgba(139,92,246,.20), transparent 62%),
        radial-gradient(550px 240px at 80% 0%, rgba(34,211,238,.16), transparent 62%);
      opacity:.55;
      pointer-events:none;
    }
    .panelHeader{
      position:relative;
      padding: 16px 16px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .panelHeader h2{
      margin:0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .22em;
      color: rgba(233,238,252,.92);
    }
    .panelHeader .hint{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.02em;
      max-width: 280px;
      text-align:right;
    }
    .panelBody{
      position:relative;
      padding: 14px 16px 16px;
      height: calc(100% - 56px);
      overflow:auto;
    }
    .panelBody::-webkit-scrollbar{ width: 10px; }
    .panelBody::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.15);
    }

    .controlGroup{ display:flex; flex-direction:column; gap: 12px; }
    .seg{
      display:flex;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
      align-items:center;
      gap: 0;
    }
    .seg button{
      flex:1;
      padding: 10px 12px;
      border:0;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      font-weight: 750;
      letter-spacing:.02em;
      transition: background .16s ease, color .16s ease;
      min-height: 44px;
    }
    .seg button[aria-pressed="true"]{
      color: rgba(233,238,252,.98);
      background: linear-gradient(135deg, rgba(139,92,246,.35), rgba(34,211,238,.18));
    }

    .row{ display:flex; gap: 12px; align-items:center; }
    .label{ font-size: 12px; color: var(--muted); width: 140px; letter-spacing:.02em; line-height:1.25; }
    .value{ margin-left:auto; font-family: var(--mono); font-size: 12px; color: rgba(233,238,252,.95); opacity:.95; }
    input[type="range"]{ width:100%; accent-color: #b79bff; }
    .rangeBox{ flex: 1; display:flex; flex-direction:column; gap: 6px; }
    .micro{ font-size: 11px; color: var(--dim); letter-spacing:.02em; }

    .card{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius2);
      padding: 14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .kpiGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .kpi{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
    }
    .kpi .t{
      font-size: 11px;
      color: var(--muted);
      letter-spacing:.12em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .kpi .n{ font-family: var(--mono); font-size: 16px; font-weight: 900; letter-spacing: .02em; }
    .kpi .s{ font-size: 11px; color: var(--dim); margin-top: 6px; line-height:1.35; }

    .status{ display:flex; align-items:center; gap: 12px; }
    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing:.14em;
      text-transform: uppercase;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      white-space: nowrap;
    }
    .badge.ok{ color: rgba(110,231,183,.95); box-shadow: 0 0 0 3px rgba(110,231,183,.12); }
    .badge.warn{ color: rgba(251,191,36,.95); box-shadow: 0 0 0 3px rgba(251,191,36,.12); }
    .badge.danger{ color: rgba(251,113,133,.95); box-shadow: 0 0 0 3px rgba(251,113,133,.12); }
    .badge.critical{ color: rgba(244,63,94,.95); box-shadow: 0 0 0 3px rgba(244,63,94,.12); }
    .status p{ margin:0; color: var(--muted); font-size: 12px; line-height:1.35; }

    .stage{ height:100%; display:flex; flex-direction:column; min-height:0; }
    .stageTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 14px 16px 12px;
      position:relative;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .stageTop .left{ display:flex; flex-direction:column; gap: 6px; min-width: 260px; }
    .stageTop h2{
      margin:0;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .22em;
      color: rgba(233,238,252,.92);
    }
    .stageTop .sub{ font-size: 12px; color: var(--muted); }
    .stageTop .right{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }

    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.95);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 850;
      letter-spacing:.02em;
      transition: transform .16s ease, background .16s ease;
      outline:none;
      white-space: nowrap;
      min-height: 42px;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }
    .btn:focus-visible{ box-shadow: var(--focus); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(139,92,246,.45), rgba(34,211,238,.22));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 12px 40px rgba(139,92,246,.16);
    }

    .stageCanvasWrap{ position:relative; flex:1; min-height:0; padding: 12px; }
    canvas#sky{
      width:100%;
      height:100%;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(1200px 700px at 25% 20%, rgba(139,92,246,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 35%, rgba(34,211,238,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.35));
      box-shadow: var(--shadow);
      display:block;
    }

    .hud{
      position:absolute;
      top: 26px; left: 26px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      max-width: 380px;
      pointer-events:none;
    }
    .hudRow{ display:flex; gap: 10px; flex-wrap:wrap; }
    .chip{
      display:flex; align-items:center; gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
    }
    .chip .k{ font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing:.14em; }
    .chip .v{ font-family: var(--mono); font-size: 12px; font-weight: 900; color: rgba(233,238,252,.98); }

    /* Overlay alert dock bottom-right + collapsible */
    .overlayAlert{
      position:absolute;
      right: 22px; bottom: 22px;
      top:auto;
      width: min(420px, 42%);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.20));
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index: 4;
    }
    .overlayAlert .head{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .overlayAlert .head strong{
      font-size: 12px;
      letter-spacing:.18em;
      text-transform: uppercase;
    }
    .overlayAlert .body{
      padding: 12px 14px 14px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.45;
    }
    .overlayAlert .steps{ margin: 10px 0 0; padding: 0 0 0 16px; color: rgba(233,238,252,.92); }
    .overlayAlert .steps li{ margin: 6px 0; }
    .overlayAlert[data-level="ok"] strong{ color: rgba(110,231,183,.95); }
    .overlayAlert[data-level="warn"] strong{ color: rgba(251,191,36,.95); }
    .overlayAlert[data-level="danger"] strong{ color: rgba(251,113,133,.95); }
    .overlayAlert[data-level="critical"] strong{ color: rgba(244,63,94,.98); }
    .overlayAlert.min .body{ display:none; }
    .ovToggle{
      margin-left:auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(233,238,252,.92);
      border-radius: 999px;
      padding: 6px 10px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.02em;
      min-height: unset;
      height: 28px;
    }
    .ovToggle:hover{ background: rgba(255,255,255,.06); }

    /* Enterprise */
    .projects{
      flex:1;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      min-height:0;
    }
    .searchBox{
      display:flex;
      gap: 10px;
      align-items:center;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      padding: 10px 12px;
    }
    .searchBox input{
      flex:1;
      background: transparent;
      border:0;
      color: rgba(233,238,252,.95);
      outline:none;
      font-size: 13px;
      letter-spacing:.02em;
    }
    .filterPills{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .fp{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      cursor:pointer;
      font-weight: 850;
      font-size: 12px;
      letter-spacing:.02em;
      outline:none;
    }
    .fp[aria-pressed="true"]{
      color: rgba(233,238,252,.98);
      background: linear-gradient(135deg, rgba(139,92,246,.40), rgba(34,211,238,.18));
      border-color: rgba(255,255,255,.18);
    }

    .cards{ display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap: 14px; }
    .projCard{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .projCard::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 200px at 25% 0%, rgba(139,92,246,.25), transparent 60%),
                  radial-gradient(500px 220px at 85% 0%, rgba(34,211,238,.18), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }
    .projCard .inner{
      position:relative;
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 180px;
    }
    .projCard h3{ margin:0; font-size: 14px; letter-spacing:.02em; }
    .projCard p{ margin:0; color: var(--muted); font-size: 12px; line-height:1.45; flex:1; }
    .tags{ display:flex; flex-wrap:wrap; gap: 8px; }
    .tag{
      font-family: var(--mono);
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.88);
    }
    .projCard .actions{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .linkBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.95);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.02em;
      width: fit-content;
      outline:none;
      min-height: 42px;
    }
    .linkBtn:hover{ background: rgba(255,255,255,.06); }

    /* Services menu cards */
    .svcTopRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    .svcTitle{
      font-size: 12px; letter-spacing:.18em; text-transform: uppercase;
      color: rgba(233,238,252,.92); font-weight: 900;
    }
    .svcMini{ color: rgba(169,179,214,.95); font-size: 12px; }
    .svcGrid{ display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap: 14px; margin-top: 12px; }
    .svcCard{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      box-shadow: 0 10px 35px rgba(0,0,0,.40);
      overflow:hidden;
      position:relative;
      cursor:pointer;
      outline:none;
      transition: transform .16s ease, background .16s ease;
    }
    .svcCard:hover{ transform: translateY(-2px); background: rgba(255,255,255,.06); }
    .svcCard::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(520px 180px at 25% 0%, rgba(139,92,246,.22), transparent 60%),
                  radial-gradient(520px 210px at 85% 0%, rgba(34,211,238,.16), transparent 60%);
      opacity:.55;
      pointer-events:none;
    }
    .svcInner{ position:relative; padding: 14px; display:flex; gap: 12px; align-items:flex-start; }
    .svcThumb{
      width: 92px; height: 92px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      flex: 0 0 auto;
      display:grid; place-items:center;
    }
    .svcThumb img{ width:100%; height:100%; object-fit: cover; display:block; }
    .svcName{ font-weight: 950; letter-spacing:.02em; margin:0; font-size: 14px; }
    .svcDesc{ margin:6px 0 0; color: rgba(169,179,214,.95); font-size: 12px; line-height:1.45; }
    .svcMeta{ margin-top: 10px; display:flex; gap: 8px; flex-wrap:wrap; align-items:center; }
    .svcPill{
      font-family: var(--mono);
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.88);
    }

    .stepper{
      display:flex; gap: 10px; flex-wrap:wrap; align-items:center;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      margin-bottom: 12px;
    }
    .step{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(169,179,214,.95);
      font-weight: 900;
      letter-spacing:.02em;
      font-size: 12px;
      background: rgba(255,255,255,.03);
    }
    .step.on{
      color: rgba(233,238,252,.98);
      border-color: rgba(255,255,255,.18);
      background: linear-gradient(135deg, rgba(139,92,246,.35), rgba(34,211,238,.20));
      box-shadow: 0 18px 50px rgba(139,92,246,.14);
    }
    .cartPillBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(135deg, rgba(139,92,246,.45), rgba(34,211,238,.22));
      color: rgba(233,238,252,.95);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.02em;
      white-space: nowrap;
      min-height: 42px;
    }

    /* Service modal */
    .svcMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 18px;
    }
    .svcMask.show{ display:flex; }
    .svcModal{
      width: min(980px, 96vw);
      height: min(680px, 92vh);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.25));
      box-shadow: 0 30px 110px rgba(0,0,0,.65);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .svcModalTop{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .svcModalTop h3{ margin:0; letter-spacing:.18em; text-transform: uppercase; font-size: 13px; }
    .svcModalTop .right{ margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .svcModalBody{
      flex:1; min-height:0;
      display:grid;
      grid-template-columns: 340px 1fr;
    }
    .svcModalLeft{
      border-right: 1px solid rgba(255,255,255,.10);
      padding: 14px;
      overflow:auto;
    }
    .svcModalRight{
      padding: 14px 16px;
      overflow:auto;
      min-height:0;
    }
    .svcBigThumb{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background: rgba(0,0,0,.22);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .svcBigThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .qtyRow{ display:flex; align-items:center; gap: 10px; margin-top: 12px; }
    .qtyBtn{
      width:40px; height:40px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.95);
      cursor:pointer;
      font-weight: 900;
      outline:none;
    }
    .qtyBtn:hover{ background: rgba(255,255,255,.06); }
    .qtyVal{ font-family: var(--mono); font-weight: 900; min-width: 44px; text-align:center; }
    .svcNote{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.95);
      padding: 10px 12px;
      outline:none;
      min-height: 90px;
      resize: vertical;
      font-family: var(--mono);
    }
    .svcActions{ margin-top: 10px; display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    .svcBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.95);
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.02em;
      outline:none;
      min-height: 42px;
    }
    .svcBtn:hover{ background: rgba(255,255,255,.06); }
    .svcBtn.primary{
      background: linear-gradient(135deg, rgba(139,92,246,.45), rgba(34,211,238,.22));
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 12px 40px rgba(139,92,246,.16);
    }

    /* IFE */
    .ife{
      flex:1;
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      min-height:0;
    }
    .appGrid{ display:grid; grid-template-columns: repeat(2, minmax(140px, 1fr)); gap: 12px; }
    .appTile{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 14px;
      cursor:pointer;
      transition: transform .16s ease, background .16s ease;
      outline:none;
      box-shadow: 0 14px 40px rgba(0,0,0,.32);
      display:flex;
      flex-direction:column;
      gap: 10px;
      min-height: 132px;
      position:relative;
      overflow:hidden;
    }
    .appTile::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(400px 180px at 20% 0%, rgba(139,92,246,.22), transparent 55%),
                  radial-gradient(420px 200px at 85% 0%, rgba(34,211,238,.18), transparent 55%);
      opacity:.55; pointer-events:none;
    }
    .appTile:hover{ transform: translateY(-2px); background: rgba(255,255,255,.06); }
    .appTile:focus-visible{ box-shadow: var(--focus); }
    .appTile .name{ font-weight: 950; letter-spacing:.02em; position:relative; }
    .appTile .desc{ color: var(--muted); font-size: 12px; line-height:1.35; position:relative; }
    .appTile .mini{
      margin-top:auto;
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(233,238,252,.85);
      opacity:.9;
      position:relative;
    }

    .player{ height:100%; display:flex; flex-direction:column; gap: 12px; min-height:0; }
    .playerTop{ display:flex; align-items:center; gap: 10px; flex-wrap:wrap; }
    video{
      width:100%;
      height:100%;
      background: rgba(0,0,0,.35);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
    }
    .drop{
      flex:1;
      min-height:0;
      border-radius: var(--radius);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      color: var(--muted);
      text-align:center;
      line-height:1.45;
    }
    .drop strong{ color: rgba(233,238,252,.92); }
    .split{ flex:1; min-height:0; display:grid; grid-template-rows: 1fr 140px; gap: 12px; }

    .spacer{ flex:1; }
    .mono{ font-family: var(--mono); }
    .hr{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }
    .small{ font-size: 12px; color: var(--muted); line-height:1.45; }
    .callout{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px 14px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.45;
    }
    .callout b{ color: rgba(233,238,252,.92); }

    /* ===== Settings Modal ===== */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 9998;
      padding: 18px;
    }
    .modalMask.show{ display:flex; }
    .modal{
      width: min(980px, 96vw);
      height: min(680px, 92vh);
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.25));
      box-shadow: 0 30px 110px rgba(0,0,0,.65);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalTop{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalTop h3{
      margin:0;
      letter-spacing:.18em;
      text-transform: uppercase;
      font-size: 13px;
    }
    .modalTop .right{ margin-left:auto; display:flex; gap:10px; align-items:center; }
    .modalBody{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 280px 1fr;
    }
    .modalNav{
      border-right: 1px solid rgba(255,255,255,.10);
      padding: 12px;
      overflow:auto;
    }
    .navItem{
      width:100%;
      text-align:left;
      padding: 12px 12px;
      margin: 6px 0;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.92);
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.02em;
      outline:none;
      min-height: 44px;
    }
    .navItem[aria-pressed="true"]{
      background: linear-gradient(135deg, rgba(139,92,246,.35), rgba(34,211,238,.20));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 18px 50px rgba(139,92,246,.14);
    }
    .modalPane{
      padding: 14px 16px;
      overflow:auto;
      min-height:0;
    }
    .field{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      align-items:center;
      margin: 10px 0;
    }
    .field label{
      color: var(--muted);
      font-size: 12px;
      letter-spacing:.02em;
    }
    .field input, .field select, .field textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(233,238,252,.95);
      padding: 10px 12px;
      outline:none;
      font-family: var(--sans);
      min-height: 42px;
    }
    .field textarea{ min-height: 120px; resize: vertical; font-family: var(--mono); }
    .inlineBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .mutedBox{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding: 12px;
      color: var(--muted);
      font-size: 12px;
      line-height:1.45;
    }

    @media (max-width: 1200px){
      .grid{ grid-template-columns: 1fr; }
      .projects{ grid-template-columns: 1fr; }
      .cards{ grid-template-columns: 1fr; }
      .svcGrid{ grid-template-columns: 1fr; }
      .ife{ grid-template-columns: 1fr; }
      .overlayAlert{ width: min(460px, 76%); }
      .tabs{ max-width: 100%; margin-left: 0; }
      .tabbtn{ min-width: 0; flex:1; }
      body{ overflow:auto; }
      .app{ overflow:auto; }
      .modalBody{ grid-template-columns: 1fr; }
      .modalNav{ border-right:0; border-bottom: 1px solid rgba(255,255,255,.10); display:flex; gap:10px; }
      .navItem{ margin:0; }
      .svcModalBody{ grid-template-columns: 1fr; }
      .svcModalLeft{ border-right:0; border-bottom: 1px solid rgba(255,255,255,.10); }
    }
  </style>
</head>

<body>
  <div class="fx"></div>

  <div class="app" id="app">
    <div class="topbar">
      <div class="brand" id="brand">
        <div class="logo" aria-hidden="true">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M3 13.2l18-7.2-7.2 18-2.3-7.2L3 13.2z" fill="rgba(255,255,255,.92)"/>
            <path d="M11.5 16.8l3.8-3.8" stroke="rgba(0,0,0,.25)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1 id="brandTitle">AERO•PORTAL</h1>
          <div class="sub" id="brandSub">Cabin Safety Intelligence • Premium In-Flight Experience</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="AERO tabs">
        <button class="tabbtn" role="tab" aria-controls="view-safety" data-tab="safety" data-active="true">
          <svg class="tabicon" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l9 4v6c0 6-4 9-9 10C7 21 3 18 3 12V6l9-4z" stroke="rgba(233,238,252,.92)" stroke-width="1.7"/>
            <path d="M12 7v6" stroke="rgba(233,238,252,.92)" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M12 16.8h.01" stroke="rgba(233,238,252,.92)" stroke-width="3.2" stroke-linecap="round"/>
          </svg>
          An toàn
        </button>

        <button class="tabbtn" role="tab" aria-controls="view-projects" data-tab="projects" data-active="false">
          <svg class="tabicon" viewBox="0 0 24 24" fill="none">
            <path d="M4 7h16M4 12h16M4 17h16" stroke="rgba(233,238,252,.92)" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M7 6.5v14" stroke="rgba(233,238,252,.45)" stroke-width="1.2"/>
          </svg>
          Dịch vụ
        </button>

        <button class="tabbtn" role="tab" aria-controls="view-ife" data-tab="ife" data-active="false">
          <svg class="tabicon" viewBox="0 0 24 24" fill="none">
            <path d="M4 6h16v12H4z" stroke="rgba(233,238,252,.92)" stroke-width="1.7" />
            <path d="M10 9l6 3-6 3V9z" fill="rgba(233,238,252,.92)"/>
          </svg>
          Giải trí
        </button>
      </div>

      <div class="meta">
        <div class="pill" title="Seat personalization">
          <span>Ghế</span>
          <strong id="seatLabel">—</strong>
          <span class="mono" id="profileLabel">ADULT</span>
        </div>
        <div class="pill" title="System Health">
          <span class="dot" id="sysDot"></span>
          <span>Hệ thống</span>
          <strong id="sysState">READY</strong>
        </div>
        <div class="pill" title="Local Time">
          <span>Giờ</span>
          <strong id="clock">--:--:--</strong>
        </div>
        <button class="btn" id="btnSettings" title="Settings / CMS / Policy">⚙ Cài đặt</button>
      </div>
    </div>

    <section class="view active" id="view-safety" role="tabpanel">
      <div class="grid">
        <div class="panel">
          <div class="panelHeader">
            <h2>Thông số cabin</h2>
            <div class="hint">Chọn: Độ cao cabin hoặc Áp suất cabin</div>
          </div>
          <div class="panelBody">
            <div class="controlGroup">
              <div class="seg" role="group" aria-label="Input mode">
                <button id="modeAlt" aria-pressed="true">Độ cao cabin</button>
                <button id="modePress" aria-pressed="false">Áp suất cabin</button>
              </div>

              <div class="card">
                <div class="row">
                  <div class="label">Độ cao cabin</div>
                  <div class="value" id="altLabel">2,400 m</div>
                </div>
                <div class="rangeBox">
                  <input id="altRange" type="range" min="0" max="9000" value="2400" step="1" />
                  <div class="micro">0 → 9,000 m (mô phỏng). Cabin thường ~ 1,800–2,500 m.</div>
                </div>

                <div class="hr"></div>

                <div class="row">
                  <div class="label">Áp suất cabin</div>
                  <div class="value" id="pressLabel">~ 750 hPa</div>
                </div>
                <div class="rangeBox">
                  <input id="pressRange" type="range" min="350" max="1013" value="750" step="1" />
                  <div class="micro">350 → 1013 hPa (mô phỏng). 1013 hPa ≈ mực nước biển.</div>
                </div>

                <div class="hr"></div>

                <div class="row">
                  <div class="label">Mô phỏng</div>
                  <div class="value" id="simLabel">AUTO</div>
                </div>
                <div class="row">
                  <button class="btn" id="btnSim">AUTO</button>
                  <button class="btn" id="btnPause">Tạm dừng</button>
                  <button class="btn primary" id="btnReset">Đặt lại</button>
                  <div class="spacer"></div>
                  <button class="btn" id="btnLang">VI</button>
                </div>
              </div>

              <div class="card">
                <div class="status">
                  <span class="badge ok" id="statusBadge">OK</span>
                  <p id="statusText">Cabin đang trong vùng an toàn mô phỏng.</p>
                </div>

                <div class="hr"></div>

                <div class="kpiGrid">
                  <div class="kpi">
                    <div class="t" id="kpiT1">O₂ khả dụng</div>
                    <div class="n" id="o2Avail">~ 74%</div>
                    <div class="s">So với mực nước biển (ước tính theo áp suất).</div>
                  </div>
                  <div class="kpi">
                    <div class="t" id="kpiT2">O₂ tương đương</div>
                    <div class="n" id="o2Eq">~ 15.5%</div>
                    <div class="s">“Cảm giác” tương đương nồng độ O₂ ở mực nước biển.</div>
                  </div>
                  <div class="kpi">
                    <div class="t" id="kpiT3">Áp suất cabin</div>
                    <div class="n" id="kpiPress">~ 750 hPa</div>
                    <div class="s">Từ slider / mô phỏng ISA.</div>
                  </div>
                  <div class="kpi">
                    <div class="t" id="kpiT4">Độ cao cabin</div>
                    <div class="n" id="kpiAlt">2,400 m</div>
                    <div class="s">Từ slider / quy đổi áp suất.</div>
                  </div>
                </div>
              </div>

              <div class="callout">
                <b>Nguyên tắc vàng:</b> Nếu có cảnh báo áp suất/oxy — <b>đeo mặt nạ oxy khi được yêu cầu</b>, thắt dây an toàn, và <b>làm theo hướng dẫn tiếp viên</b>.
              </div>
            </div>
          </div>
        </div>

        <div class="panel stage">
          <div class="stageTop">
            <div class="left">
              <h2 id="stageTitle">Mô phỏng chuyến bay</h2>
              <div class="sub" id="stageSub">Mô phỏng bay • HUD cabin • cảnh báo theo ngưỡng</div>
            </div>
            <div class="right">
              <button class="btn" id="btnTheme">Theme: DARK</button>
            </div>
          </div> 
          <div class="stageCanvasWrap">
            <canvas id="sky"></canvas>

            <div class="hud" aria-hidden="true">
              <div class="hudRow">
                <div class="chip"><div class="k" id="hudK1">Hành trình</div><div class="v" id="hudCruise">ON</div></div>
                <div class="chip"><div class="k" id="hudK2">Tốc độ</div><div class="v" id="hudSpeed">~ 840 km/h</div></div>
                <div class="chip"><div class="k" id="hudK3">Ngoài trời</div><div class="v" id="hudOat">-45°C</div></div>
              </div>
              <div class="hudRow">
                <div class="chip"><div class="k" id="hudK4">Độ cao cabin</div><div class="v" id="hudCabAlt">2,400 m</div></div>
                <div class="chip"><div class="k" id="hudK5">Áp suất cabin</div><div class="v" id="hudCabPress">750 hPa</div></div>
                <div class="chip"><div class="k" id="hudK6">O₂ khả dụng</div><div class="v" id="hudO2">74%</div></div>
              </div>
            </div>

            <div class="overlayAlert" id="overlayAlert" data-level="ok">
              <div class="head">
                <strong id="overlayTitle">Trạng thái: OK</strong>
                <span class="mono" id="overlayMetric">O₂ ~ 74%</span>
                <button class="ovToggle" id="ovToggle" title="Thu gọn / mở rộng">▾</button>
              </div>
              <div class="body">
                <div id="overlayText">Cabin đang trong vùng an toàn mô phỏng.</div>
                <ul class="steps" id="overlaySteps"></ul>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader">
            <h2 id="effectsTitle">Tác động lên cơ thể</h2>
            <div class="hint" id="effectsHint">Giải thích tác động + hướng dẫn (mô phỏng)</div>
          </div>

          <div class="panelBody">
            <div class="card" id="effectsCard">
              <h3 style="margin:0 0 10px; font-size:14px;" id="effectsH1">Với mức oxy/áp suất này, cơ thể có thể gặp:</h3>
              <div class="small" id="effectsText">
                Thường là ít ảnh hưởng ở phần lớn hành khách. Một số người nhạy cảm có thể hơi mệt/khó chịu nhẹ.
              </div>

              <div class="hr"></div>

              <h3 style="margin:0 0 10px; font-size:14px;" id="effectsH2">Bạn nên làm gì:</h3>
              <ul class="small" id="adviceList" style="margin:0; padding-left: 18px;"></ul>
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="small" id="quickExplain">
                <b>Giải thích nhanh:</b> “O₂ khả dụng” giảm chủ yếu vì <b>áp suất</b> giảm theo độ cao. Nồng độ O₂ vẫn ~20.9%, nhưng “lượng O₂ hữu ích” giảm.
              </div>
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="small mono" id="techExplain">
                Model: ISA (0–11 km) + quy đổi áp suất/độ cao + O₂_avail ≈ P/P0
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="view" id="view-projects" role="tabpanel">
      <div class="projects">
        <div class="panel">
          <div class="panelHeader">
            <h2 id="svcLeftTitle">Dịch vụ</h2>
            <div class="hint" id="svcLeftHint">Menu • đặt món • trạng thái đơn</div>
          </div>
          <div class="panelBody">
            <div class="searchBox">
              <span style="opacity:.9">🔎</span>
              <input id="svcSearch" placeholder="Tìm món ăn, đồ uống, từ khóa..." autocomplete="off" />
              <button class="btn" id="btnClearSvcSearch">Xóa</button>
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="row">
                <div class="label">Danh mục</div>
                <div class="value mono" id="svcActive">—</div>
              </div>
              <div class="filterPills" id="svcPills" style="margin-top:10px"></div>
            </div>

            <div class="hr"></div>

            <div class="card" id="orderStatusCard">
              <div class="row">
                <div class="label">Trạng thái đơn</div>
                <div class="value mono" id="orderStateVal">NHÁP</div>
              </div>
              <div class="small" id="orderStateSub" style="margin-top:10px; line-height:1.45"></div>
              <div class="inlineBtns" style="margin-top:10px">
                <button class="btn" id="btnViewCart">Xem giỏ</button>
                <button class="btn primary" id="btnConfirmOrder">Xác nhận</button>
                <button class="btn" id="btnSendOrder">Gửi tiếp viên</button>
                <button class="btn" id="btnClearOrder">Xóa</button>
              </div>
              <div class="hr"></div>
              <div class="small"><b>Ghi chú cho tiếp viên</b></div>
              <textarea id="orderNote" class="svcNote" placeholder="VD: ít đá / không phô mai / không hành..."></textarea>
            </div>

            <div class="hr"></div>

            <div class="callout">
              <b>Gợi ý:</b> Bấm “Xác nhận” trước, sau đó “Gửi tiếp viên” để mô phỏng quy trình 3 bước.
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panelHeader">
            <h2 id="svcRightTitle">Menu trên máy bay</h2>
            <div class="hint" id="svcRightHint">Bấm món → xem chi tiết → thêm vào giỏ → gửi tiếp viên</div>
          </div>
          <div class="panelBody">
            <div class="seg" style="margin-bottom:12px">
              <button id="entBtnMenu" aria-pressed="true">Menu</button>
              <button id="entBtnShowcase" aria-pressed="false">Showcase</button>
              <button class="cartPillBtn" id="entCartBtn" style="flex:0 0 auto;">🛒 Giỏ <span class="mono" id="entCartCount">0</span></button>
            </div>

            <div class="stepper" id="entStepper">
              <div class="step on" data-step="1">1) Chọn món</div>
              <div class="step" data-step="2">2) Xác nhận</div>
              <div class="step" data-step="3">3) Gửi tiếp viên</div>
              <div class="spacer"></div>
              <div class="svcMini mono" id="entSeatMini">SEAT: —</div>
            </div>

            <div id="menuWrap">
              <div class="svcTopRow">
                <div class="svcTitle" id="entCatTitle">—</div>
                <div class="svcMini" id="entCatHint"></div>
              </div>
              <div class="svcGrid" id="svcGrid"></div>

              <div class="hr"></div>
              <div class="callout"><b>Chính sách:</b> nếu domain không nằm trong whitelist, hệ thống sẽ <b>chặn</b> và ghi log.</div>
            </div>

            <div id="showcaseWrap" style="display:none">
              <div class="cards" id="projCards"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="view" id="view-ife" role="tabpanel">
      <div class="ife">
        <div class="panel">
          <div class="panelHeader">
            <h2>App Launcher</h2>
            <div class="hint">Chỉ mở domain trong whitelist</div>
          </div>
          <div class="panelBody">
            <div class="appGrid" id="appGrid"></div>
            <div class="hr"></div>
            <div class="callout">
              <b>Chính sách:</b> nếu domain không nằm trong whitelist, hệ thống sẽ <b>chặn</b> và ghi log.
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="row">
                <div class="label">Thư viện nội bộ</div>
                <div class="value" id="mediaCount">0</div>
              </div>
              <div class="small" style="margin-top:10px" id="mediaHint">
                Danh sách video demo/đào tạo — cấu hình trong Cài đặt → CMS (IFE library).
              </div>
              <div class="inlineBtns" id="mediaBtns"></div>
            </div>
          </div>
        </div>

        <div class="panel player">
          <div class="panelHeader">
            <h2>Trình phát trên máy bay</h2>
            <div class="hint">Video nội bộ / file local (demo)</div>
          </div>
          <div class="panelBody">
            <div class="playerTop">
              <button class="btn primary" id="btnPickVideo">Chọn video</button>
              <button class="btn" id="btnStopVideo">Dừng</button>
              <div class="spacer"></div>
              <div class="pill"><span>Chế độ</span><strong id="ifeMode">LOCAL</strong></div>
            </div>

            <div class="split">
              <video id="video" controls playsinline></video>

              <div class="drop" id="drop">
                Kéo-thả file video vào đây hoặc bấm <strong>“Chọn video”</strong>.<br/>
                (Bản thật thường phát từ <strong>server nội bộ</strong> để offline.)
              </div>
            </div>

            <input type="file" id="fileVideo" accept="video/*" hidden />
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="modalMask" id="modalMask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <h3 id="settingsTitle">Cài đặt • CMS • Chính sách</h3>
        <div class="right">
          <div class="pill"><span>Lưu trữ</span><strong id="storageState">LOCAL</strong></div>
          <button class="btn" id="btnCloseSettings">Đóng</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="modalNav">
          <button class="navItem" data-pane="seat" aria-pressed="true">Ghế</button>
          <button class="navItem" data-pane="cms" aria-pressed="false">CMS</button>
          <button class="navItem" data-pane="security" aria-pressed="false">Bảo mật</button>
          <button class="navItem" data-pane="logs" aria-pressed="false">Nhật ký</button>
        </div>

        <div class="modalPane" id="paneSeat">
          <div class="mutedBox">
            <b>Seat personalization</b>: lưu offline (localStorage). Dùng để hiển thị Seat ID / profile / language.
          </div>

          <div class="field">
            <label>Mã ghế</label>
            <input id="seatIdInput" placeholder="VD: 1A / 12C / VIP-01" />
          </div>

          <div class="field">
            <label>Hồ sơ hành khách</label>
            <select id="profileInput">
              <option value="adult">Adult</option>
              <option value="kid">Kid</option>
            </select>
          </div>

          <div class="field">
            <label>Ngôn ngữ</label>
            <select id="langInput">
              <option value="vi">VI</option>
              <option value="en">EN</option>
            </select>
          </div>

          <div class="inlineBtns">
            <button class="btn primary" id="btnSaveSeat">Lưu</button>
            <button class="btn" id="btnResetSeat">Reset ghế</button>
          </div>
        </div>

        <div class="modalPane" id="paneCMS" style="display:none">
          <div class="mutedBox">
            <b>CMS JSON</b>: Import/Export toàn bộ cấu hình (Brand/Services/Projects/Apps/Whitelist/IFE).<br/>
            <span class="mono">Tip:</span> Import là “đổi hệ thống” trong 3 giây.
          </div>

          <div class="field">
            <label>Tên thương hiệu</label>
            <input id="brandTitleInput" placeholder="AERO•PORTAL" />
          </div>
          <div class="field">
            <label>Mô tả thương hiệu</label>
            <input id="brandSubInput" placeholder="Cabin Safety • Premium IFE" />
          </div>

          <div class="field">
            <label>Nhập JSON</label>
            <input type="file" id="configFile" accept="application/json" />
          </div>

          <div class="field">
            <label>Xuất JSON</label>
            <textarea id="configPreview" spellcheck="false"></textarea>
          </div>

          <div class="inlineBtns">
            <button class="btn primary" id="btnApplyBrand">Áp dụng</button>
            <button class="btn" id="btnExport">Làm mới</button>
            <button class="btn" id="btnFactory">Khôi phục mặc định</button>
          </div>
        </div>

        <div class="modalPane" id="paneSecurity" style="display:none">
          <div class="mutedBox">
            <b>Whitelist Policy</b>: chỉ cho phép mở URL nếu domain match whitelist.<br/>
            Mỗi lần mở / bị chặn sẽ ghi vào Logs.
          </div>

          <div class="field">
            <label>Whitelist domains</label>
            <textarea id="whitelistInput" spellcheck="false" placeholder="youtube.com
netflix.com
intranet.airline.local"></textarea>
          </div>

          <div class="inlineBtns">
            <button class="btn primary" id="btnSaveWhitelist">Lưu</button>
            <button class="btn" id="btnTighten">Siết whitelist (an toàn)</button>
          </div>

          <div class="hr"></div>
          <div class="mutedBox">
            <b>Security note</b>: kiosk thật thường dùng thêm layer hệ điều hành (kiosk mode) + proxy nội bộ.
          </div>
        </div>

        <div class="modalPane" id="paneLogs" style="display:none">
          <div class="mutedBox">
            <b>Event Logs</b>: lưu local, giới hạn 200 entries.
          </div>

          <div class="inlineBtns">
            <button class="btn" id="btnRefreshLogs">Làm mới</button>
            <button class="btn" id="btnClearLogs">Xóa log</button>
            <button class="btn primary" id="btnCopyLogs">Copy</button>
          </div>

          <div class="field" style="grid-template-columns:1fr">
            <textarea id="logsBox" spellcheck="false"></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="svcMask" id="svcMask" aria-hidden="true">
    <div class="svcModal" role="dialog" aria-modal="true">
      <div class="svcModalTop">
        <h3 id="svcModalTitle">CHI TIẾT</h3>
        <div class="right">
          <div class="pill"><span>Ghế</span><strong id="svcSeat">—</strong></div>
          <button class="btn" id="svcClose">Đóng</button>
        </div>
      </div>
      <div class="svcModalBody">
        <div class="svcModalLeft">
          <div class="svcBigThumb"><img id="svcImg" alt="thumb"/></div>
          <div class="qtyRow">
            <div class="label" style="width:auto">Số lượng</div>
            <button class="qtyBtn" id="qtyMinus">−</button>
            <div class="qtyVal" id="qtyVal">1</div>
            <button class="qtyBtn" id="qtyPlus">+</button>
          </div>
          <div class="hr"></div>
          <div class="small" style="margin-bottom:8px"><b>Ghi chú cho tiếp viên</b></div>
          <textarea class="svcNote" id="svcItemNote" placeholder="VD: ít đá / không phô mai / không hành..."></textarea>
        </div>
        <div class="svcModalRight">
          <h3 style="margin:0 0 8px; font-size:16px" id="svcName">—</h3>
          <div class="small" id="svcDesc">—</div>
          <div class="hr"></div>
          <div class="tags" id="svcTags"></div>
          <div class="hr"></div>
          <div class="svcActions">
            <button class="svcBtn primary" id="svcAdd">Thêm vào giỏ</button>
            <button class="svcBtn" id="svcViewCart">🛒 Xem giỏ</button>
          </div>
          <div class="hr"></div>
          <div class="mutedBox" id="svcExtra"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ==========================
       AERO•PORTAL v3 (single-file)
       - Safety simulation + canvas
       - Services (Meals/Drinks) + cart + 3-step flow
       - IFE apps + media library (demo aircraft videos)
       - CMS JSON import/export + whitelist policy + logs
       ========================== */

    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

    const KEY = {
      config: "aero.config.v3",
      seat: "aero.seat.v3",
      logs: "aero.logs.v3",
      orders: "aero.orders.v3"
    };

    function structuredCloneSafe(o){
      try{ return structuredClone(o); }catch{ return JSON.parse(JSON.stringify(o)); }
    }

    // ---------- Logging ----------
    function nowISO(){ return new Date().toISOString(); }
    function getLogs(){ try{ return JSON.parse(localStorage.getItem(KEY.logs) || "[]"); }catch{ return []; } }
    function pushLog(type, meta={}){
      const logs = getLogs();
      logs.push({ t: nowISO(), type, meta });
      while(logs.length > 200) logs.shift();
      localStorage.setItem(KEY.logs, JSON.stringify(logs));
    }

    // ---------- URL policy ----------
    function normalizeHost(u){
      try{ return new URL(u).hostname.toLowerCase(); }catch{ return ""; }
    }
    function hostAllowed(host, whitelist){
      const h = (host||"").toLowerCase();
      return (whitelist||[]).some(w => {
        const d = String(w||"").trim().toLowerCase();
        if(!d) return false;
        return h === d || h.endsWith("." + d);
      });
    }
    function safeOpen(url){
      if(url === "#"){
        toast("Link nội bộ (#) — hãy thay URL thật trong CMS.");
        pushLog("open_blocked", { url, reason:"placeholder" });
        return;
      }
      if (!url.startsWith("http://") && !url.startsWith("https://")) {
        toast("Blocked: Invalid protocol");
        pushLog("open_blocked", { url, reason:"invalid_protocol" });
        return;
      }

      const host = normalizeHost(url);
      if(!host){
        toast("URL không hợp lệ.");
        pushLog("open_blocked", { url, reason:"invalid_url" });
        return;
      }
      if(!hostAllowed(host, state.config.whitelist || [])){
        toast("Bị chặn bởi policy (whitelist).");
        pushLog("open_blocked", { url, host, reason:"not_in_whitelist" });
        return;
      }
      window.open(url, "_blank", "noopener,noreferrer");
      pushLog("open_ok", { url, host });
    }

    // ---------- Default services ----------
    const SERVICES_DEFAULT = {
      categories: [
        { id: "meals",  icon: "🍱", name: { vi: "Đồ ăn", en: "Meals" } },
        { id: "drinks", icon: "🥤", name: { vi: "Đồ uống", en: "Drinks" } },
        { id: "snack",  icon: "🍪", name: { vi: "Snack", en: "Snacks" } },
        { id: "kids",   icon: "🧒", name: { vi: "Trẻ em", en: "Kids" } }
      ],
      items: [
        { id:"meal_beef", cat:"meals", name:{vi:"Cơm bò sốt tiêu đen",en:"Black-pepper beef rice"}, desc:{vi:"Cơm + bò áp chảo + sốt tiêu đen, rau củ theo mùa.",en:"Rice + seared beef + black pepper sauce, seasonal veg."}, kcal:720, allergens:["Gluten","Đậu nành"], priceVnd:180000, emoji:"🥩" },
        { id:"meal_teriyaki", cat:"meals", name:{vi:"Gà teriyaki + cơm",en:"Teriyaki chicken rice"}, desc:{vi:"Gà teriyaki mềm, cơm thơm, salad nhỏ.",en:"Tender teriyaki chicken, rice, small salad."}, kcal:690, allergens:["Đậu nành"], priceVnd:170000, emoji:"🍗" },
        { id:"meal_veggie_pasta", cat:"meals", name:{vi:"Mì Ý chay sốt cà",en:"Veggie tomato pasta"}, desc:{vi:"Mì Ý + sốt cà chua, rau củ, phô mai tuỳ chọn.",en:"Pasta + tomato sauce, veggies, optional cheese."}, kcal:610, allergens:["Gluten","Sữa"], priceVnd:160000, emoji:"🍝" },
        { id:"meal_breakfast", cat:"meals", name:{vi:"Bữa sáng trứng cuộn",en:"Breakfast omelet"}, desc:{vi:"Trứng cuộn + xúc xích + khoai nghiền.",en:"Omelet + sausage + mashed potato."}, kcal:640, allergens:["Trứng","Sữa"], priceVnd:150000, emoji:"🍳" },
        { id:"kids_nuggets", cat:"kids", name:{vi:"Set trẻ em: nugget + khoai",en:"Kids set: nuggets + fries"}, desc:{vi:"Khẩu phần nhỏ, dễ ăn. Kèm sốt.",en:"Small portion, easy to eat. Includes dip."}, kcal:520, allergens:["Gluten"], priceVnd:120000, emoji:"🍟" },
        { id:"snack_box", cat:"snack", name:{vi:"Snack box",en:"Snack box"}, desc:{vi:"Bánh quy + hạt + phô mai (tuỳ chuyến).",en:"Crackers + nuts + cheese (varies by flight)."}, kcal:430, allergens:["Hạt","Sữa","Gluten"], priceVnd:90000, emoji:"🍪" },
        { id:"dessert_cheese", cat:"snack", name:{vi:"Bánh cheesecake",en:"Cheesecake"}, desc:{vi:"Tráng miệng mềm mịn, vị vani.",en:"Smooth vanilla cheesecake."}, kcal:380, allergens:["Sữa","Trứng","Gluten"], priceVnd:80000, emoji:"🍰" },
        { id:"drink_coffee", cat:"drinks", name:{vi:"Cà phê nóng",en:"Hot coffee"}, desc:{vi:"Arabica blend, phục vụ nóng.",en:"Arabica blend, served hot."}, kcal:10, allergens:[], priceVnd:45000, emoji:"☕" },
        { id:"drink_juice", cat:"drinks", name:{vi:"Nước cam",en:"Orange juice"}, desc:{vi:"Uống lạnh, chai nhỏ.",en:"Chilled, small bottle."}, kcal:120, allergens:[], priceVnd:50000, emoji:"🍊" },
        { id:"drink_water", cat:"drinks", name:{vi:"Nước lọc",en:"Water"}, desc:{vi:"Nước đóng chai.",en:"Bottled water."}, kcal:0, allergens:[], priceVnd:30000, emoji:"💧" }
      ]
    };

    const DEMO_MEDIA = [
      { title:{vi:"A380 cất cánh (YYZ) — demo", en:"A380 takeoff (YYZ) — demo"}, url:"https://upload.wikimedia.org/wikipedia/commons/e/e2/A380_Taking_off_from_YYZ.webm" },
      { title:{vi:"Cất cánh — demo", en:"Takeoff — demo"}, url:"https://upload.wikimedia.org/wikipedia/commons/6/6a/Flight_take_off.webm" },
      { title:{vi:"Hạ cánh — demo", en:"Landing — demo"}, url:"https://upload.wikimedia.org/wikipedia/commons/3/3f/Flight_landing.webm" },
      { title:{vi:"Diễn tập an toàn — demo", en:"Safety drill — demo"}, url:"https://upload.wikimedia.org/wikipedia/commons/1/15/Airplane_evacuation.webm" }
    ];

    // ---------- Factory config ----------
    const FACTORY = {
      brand: { title:"AERO•PORTAL", subtitle:"Cabin Safety Intelligence • Premium In-Flight Experience" },
      tags: ["Aviation","Luxury","AI","Security","Hospitality","Infrastructure"],
      projects: [
        { title:"AeroSense — Cabin Intelligence Suite", desc:"Quan sát cabin theo ngưỡng, UI kiosk 5★, cảnh báo theo kịch bản, hỗ trợ crew ops.", tags:["Aviation","AI","Security"], cta:"Open Deck", url:"#"},
        { title:"SkyLine — Premium IFE Portal", desc:"Launcher giải trí + player nội bộ, quản lý nội dung offline, tối ưu màn hình ghế ngồi cảm ứng.", tags:["Aviation","Hospitality"], cta:"View Demo", url:"#"},
        { title:"Aurora — Digital Concierge", desc:"Concierge cho khách VIP: hành trình, dịch vụ, đặt suất ăn, hỗ trợ tức thì.", tags:["Luxury","Hospitality"], cta:"Explore", url:"#"},
        { title:"Sentinel — Secure Edge Runtime", desc:"Chạy ứng dụng kiosk trong môi trường kiểm soát, logging, whitelist, policy enforcement.", tags:["Security","Infrastructure"], cta:"Spec Sheet", url:"#"}
      ],
      apps: [
        { name:"YouTube", desc:"Video • Music • Live", url:"https://www.youtube.com", hint:"Opens in new tab" },
        { name:"Netflix", desc:"Movies • Series", url:"https://www.netflix.com", hint:"May require login" },
        { name:"Disney+", desc:"Family • Originals", url:"https://www.disneyplus.com", hint:"Service availability varies" },
        { name:"Prime Video", desc:"Movies • TV", url:"https://www.primevideo.com", hint:"Service availability varies" },
        { name:"Spotify", desc:"Music • Podcasts", url:"https://open.spotify.com", hint:"Audio experience" },
        { name:"Onboard Store", desc:"Wi-Fi • Duty Free • Services", url:"#", hint:"Replace with internal link" }
      ],
      whitelist: ["youtube.com","netflix.com","disneyplus.com","primevideo.com","spotify.com","upload.wikimedia.org"],
      ife: { library: structuredCloneSafe(DEMO_MEDIA) },
      services: structuredCloneSafe(SERVICES_DEFAULT)
    };

    function mergeConfig(base, incoming){
      if(incoming?.brand){
        base.brand.title = incoming.brand.title ?? base.brand.title;
        base.brand.subtitle = incoming.brand.subtitle ?? base.brand.subtitle;
      }
      if(Array.isArray(incoming?.tags)) base.tags = incoming.tags;
      if(Array.isArray(incoming?.projects)) base.projects = incoming.projects;
      if(Array.isArray(incoming?.apps)) base.apps = incoming.apps;
      if(Array.isArray(incoming?.whitelist)) base.whitelist = incoming.whitelist;
      if(incoming?.ife?.library && Array.isArray(incoming.ife.library)) base.ife.library = incoming.ife.library;
      if(incoming?.services){
        base.services = incoming.services;
        if(!Array.isArray(base.services.categories)) base.services.categories = structuredCloneSafe(SERVICES_DEFAULT.categories);
        if(!Array.isArray(base.services.items)) base.services.items = structuredCloneSafe(SERVICES_DEFAULT.items);
      }
      if(!base.ife?.library || base.ife.library.length === 0) base.ife = { library: structuredCloneSafe(DEMO_MEDIA) };
      base.whitelist = Array.isArray(base.whitelist) ? base.whitelist : [];
      if(!base.whitelist.includes("upload.wikimedia.org")) base.whitelist.push("upload.wikimedia.org");
      return base;
    }

    function loadConfig(){
      try{
        const raw = localStorage.getItem(KEY.config);
        if(!raw) return structuredCloneSafe(FACTORY);
        const cfg = JSON.parse(raw);
        return mergeConfig(structuredCloneSafe(FACTORY), cfg);
      }catch{
        return structuredCloneSafe(FACTORY);
      }
    }
    function saveConfig(cfg){
      localStorage.setItem(KEY.config, JSON.stringify(cfg));
      pushLog("config_saved", { keys: Object.keys(cfg||{}) });
    }

    // ---------- I18N ----------
    
    // ---------- I18N ----------
    const I18N = {
      vi: {
        doc_title: "AERO•PORTAL — Cabin Safety + Premium IFE (v3 Patched)",
        ui_seat_title: "Cá nhân hóa ghế",
        ui_system_title: "Tình trạng hệ thống",
        ui_time_title: "Giờ địa phương",
        ui_settings_title: "Cài đặt / CMS / Chính sách",
        ui_storage: "Lưu trữ",
        ui_close: "Đóng",
        ui_sim_auto: "AUTO",
        ui_sim_manual: "MANUAL",

        stageSub: "Mô phỏng bay • HUD cabin • cảnh báo theo ngưỡng",
        badge_ok: "OK",
        badge_warn: "CHÚ Ý",
        badge_danger: "CẢNH BÁO",
        badge_critical: "KHẨN",
        status_ok: "Cabin đang trong vùng an toàn mô phỏng.",
        status_warn: "Cabin bắt đầu vào vùng cần chú ý (mô phỏng).",
        status_danger: "Cabin vào vùng cảnh báo (mô phỏng). Ưu tiên hướng dẫn phi hành đoàn.",
        status_critical: "Cabin vào vùng khẩn (mô phỏng). Đeo mặt nạ oxy nếu được yêu cầu.",
        overlay_ok: "Trạng thái: OK",
        overlay_warn: "Trạng thái: CHÚ Ý",
        overlay_danger: "Trạng thái: CẢNH BÁO",
        overlay_critical: "Trạng thái: KHẨN",
        steps_ok: ["Giữ dây an toàn khi ngồi.","Lắng nghe thông báo của phi hành đoàn.","Không tự ý thao tác thiết bị an toàn."],
        steps_warn: ["Ngồi yên, thở đều.","Nếu thấy khó chịu: báo tiếp viên.","Sẵn sàng làm theo hướng dẫn."],
        steps_danger: ["Giữ bình tĩnh, thắt dây an toàn.","Báo tiếp viên nếu chóng mặt/khó thở.","Chuẩn bị đeo mặt nạ oxy nếu được hướng dẫn."],
        steps_critical: ["Làm theo hướng dẫn phi hành đoàn ngay lập tức.","Đeo mặt nạ oxy khi được yêu cầu.","Hỗ trợ trẻ em/người cần giúp sau khi bạn đã an toàn."],
        effects_ok: "Thường ít ảnh hưởng với phần lớn hành khách. Một số người nhạy cảm có thể hơi mệt/khó chịu nhẹ.",
        effects_warn: "Có thể mệt, khó tập trung, thở nhanh nhẹ. Người có bệnh nền có thể nhạy cảm hơn.",
        effects_danger: "Có thể chóng mặt, buồn nôn, phản xạ chậm. Ưu tiên báo tiếp viên và làm theo hướng dẫn an toàn.",
        effects_critical: "Nguy cơ rối loạn nhận thức tăng. Cần tuân thủ hướng dẫn khẩn cấp của phi hành đoàn.",
        advice_ok: ["Ngồi yên, thở đều, uống nước nếu được phép.","Nếu chóng mặt/khó thở: báo tiếp viên.","Luôn ưu tiên hướng dẫn của phi hành đoàn."],
        advice_warn: ["Hạn chế đứng dậy/di chuyển không cần thiết.","Thở chậm, đều; báo tiếp viên nếu khó chịu.","Chuẩn bị làm theo hướng dẫn an toàn."],
        advice_danger: ["Giữ bình tĩnh, thắt dây an toàn.","Báo tiếp viên ngay nếu có triệu chứng rõ.","Sẵn sàng đeo mặt nạ oxy khi được yêu cầu."],
        advice_critical: ["Tuân thủ hướng dẫn khẩn cấp ngay lập tức.","Đeo mặt nạ oxy khi được yêu cầu.","Hỗ trợ người khác sau khi bạn đã an toàn."],
        techExplain: "Model: ISA (0–11 km) + quy đổi áp suất/độ cao + O₂_avail ≈ P/P0 (mô phỏng giáo dục)",

        ui_tabs_safety: "An toàn",
        ui_tabs_services: "Dịch vụ",
        ui_tabs_ife: "Giải trí",
        ui_seat: "Ghế",
        ui_system: "Hệ thống",
        ui_time: "Giờ",
        ui_settings: "⚙ Cài đặt",
        ui_cabin_params: "Thông số cabin",
        ui_cabin_hint: "Chọn: Độ cao cabin hoặc Áp suất cabin",
        ui_alt: "Độ cao cabin",
        ui_press: "Áp suất cabin",
        ui_sim: "Mô phỏng",
        ui_pause: "Tạm dừng",
        ui_resume: "Tiếp tục",
        ui_reset: "Đặt lại",
        ui_stage_title: "Mô phỏng chuyến bay",
        ui_effects_title: "Tác động lên cơ thể",
        ui_effects_hint: "Giải thích tác động + hướng dẫn (mô phỏng)",
        ui_effects_h1: "Với mức oxy/áp suất này, cơ thể có thể gặp:",
        ui_effects_h2: "Bạn nên làm gì:",
        ui_quick_explain:
          "<b>Giải thích nhanh:</b> “O₂ khả dụng” giảm chủ yếu vì <b>áp suất</b> giảm theo độ cao. Nồng độ O₂ vẫn ~20.9%, nhưng “lượng O₂ hữu ích” giảm.",

        ui_svc_left_title: "Dịch vụ",
        ui_svc_left_hint: "Menu • đặt món • trạng thái đơn",
        ui_search_ph: "Tìm món ăn, đồ uống, từ khóa...",
        ui_clear: "Xóa",
        ui_order_state: "Trạng thái đơn",
        ui_view_cart: "Xem giỏ",
        ui_confirm: "Xác nhận",
        ui_send: "Gửi tiếp viên",
        ui_clear_order: "Xóa",
        ui_note_ph: "VD: ít đá / không phô mai / không hành...",
        ui_note_for_crew: "Ghi chú cho tiếp viên",
        ui_svc_right_title: "Menu trên máy bay",
        ui_svc_right_hint: "Bấm món → xem chi tiết → thêm vào giỏ → gửi tiếp viên",
        ui_menu: "Menu",
        ui_showcase: "Showcase",
        ui_cart: "🛒 Giỏ",
        ui_step_1: "1) Chọn món",
        ui_step_2: "2) Xác nhận",
        ui_step_3: "3) Gửi tiếp viên",
        ui_policy_callout: "<b>Chính sách:</b> nếu domain không nằm trong whitelist, hệ thống sẽ <b>chặn</b> và ghi log.",

        ui_ife_launcher: "App Launcher",
        ui_ife_launcher_hint: "Chỉ mở domain trong whitelist",
        ui_player: "Trình phát trên máy bay",
        ui_player_hint: "Video nội bộ / file local (demo)",
        ui_pick_video: "Chọn video",
        ui_stop: "Dừng",
        ui_mode: "Chế độ",
        ui_drop:
          'Kéo-thả file video vào đây hoặc bấm <strong>“Chọn video”</strong>.<br/>(Bản thật thường phát từ <strong>server nội bộ</strong> để offline.)',
        ui_internal_library: "Thư viện nội bộ",
        ui_internal_library_hint:
          "Danh sách video demo/đào tạo — cấu hình trong Cài đặt → CMS (IFE library).",
        ui_theme_dark: "Theme: DARK",
        ui_theme_light: "Theme: LIGHT",

        svc_detail_title: "CHI TIẾT",
        svc_qty: "Số lượng",
        svc_add_cart: "Thêm vào giỏ",
        svc_view_cart2: "🛒 Xem giỏ",

        settings_title: "Cài đặt • CMS • Chính sách",
        settings_nav_seat: "Ghế",
        settings_nav_cms: "CMS",
        settings_nav_security: "Bảo mật",
        settings_nav_logs: "Nhật ký",
        settings_seat_box:
          "<b>Seat personalization</b>: lưu offline (localStorage). Dùng để hiển thị Seat ID / profile / language.",
        settings_seat_id: "Mã ghế",
        settings_seat_id_ph: "VD: 1A / 12C / VIP-01",
        settings_profile: "Hồ sơ hành khách",
        settings_language: "Ngôn ngữ",
        settings_save: "Lưu",
        settings_reset_seat: "Reset ghế",
        settings_cms_box:
          "<b>CMS JSON</b>: Import/Export toàn bộ cấu hình (Brand/Services/Projects/Apps/Whitelist/IFE).<br/><span class=\"mono\">Tip:</span> Import là “đổi hệ thống” trong 3 giây.",
        settings_brand_title: "Tên thương hiệu",
        settings_brand_sub: "Mô tả thương hiệu",
        settings_import_json: "Nhập JSON",
        settings_export_json: "Xuất JSON",
        settings_apply_brand: "Áp dụng",
        settings_refresh_export: "Làm mới",
        settings_factory: "Khôi phục mặc định",
        settings_security_box:
          "<b>Whitelist Policy</b>: chỉ cho phép mở URL nếu domain match whitelist.<br/>Mỗi lần mở / bị chặn sẽ ghi vào Logs.",
        settings_whitelist: "Whitelist domains",
        settings_save_whitelist: "Lưu",
        settings_tighten: "Siết whitelist (an toàn)",
        settings_security_note:
          "<b>Security note</b>: kiosk thật thường dùng thêm layer hệ điều hành (kiosk mode) + proxy nội bộ.",
        settings_logs_box:
          "<b>Event Logs</b>: lưu local, giới hạn 200 entries.",
        settings_logs_refresh: "Làm mới",
        settings_logs_clear: "Xóa log",
        settings_logs_copy: "Copy"
      },

      en: {
        doc_title: "AERO•PORTAL — Cabin Safety + Premium IFE (v3 Patched)",
        ui_seat_title: "Seat personalization",
        ui_system_title: "System health",
        ui_time_title: "Local time",
        ui_settings_title: "Settings / CMS / Policy",
        ui_storage: "Storage",
        ui_close: "Close",
        ui_sim_auto: "AUTO",
        ui_sim_manual: "MANUAL",

        stageSub: "Flight simulation • cabin HUD • threshold-based alerts",
        badge_ok: "OK",
        badge_warn: "CAUTION",
        badge_danger: "WARNING",
        badge_critical: "CRITICAL",
        status_ok: "Cabin is within a simulated safe range.",
        status_warn: "Cabin is entering a caution zone (simulated).",
        status_danger: "Cabin is in a warning zone (simulated). Follow crew instructions.",
        status_critical: "Cabin is in a CRITICAL zone (simulated). Oxygen mask if instructed.",
        overlay_ok: "Status: OK",
        overlay_warn: "Status: CAUTION",
        overlay_danger: "Status: WARNING",
        overlay_critical: "Status: CRITICAL",
        steps_ok: ["Keep seatbelt fastened while seated.","Listen to crew announcements.","Do not operate safety equipment."],
        steps_warn: ["Remain seated and breathe calmly.","Notify crew if you feel unwell.","Be ready to follow instructions."],
        steps_danger: ["Stay calm and fasten seatbelt.","Notify crew if dizziness/shortness of breath.","Prepare for oxygen mask if instructed."],
        steps_critical: ["Follow crew emergency instructions immediately.","Put on oxygen mask if instructed.","Assist others after you are safe."],
        effects_ok: "Typically minimal impact for most passengers. Sensitive individuals may feel mild discomfort.",
        effects_warn: "May cause fatigue, reduced focus, slightly faster breathing.",
        effects_danger: "May cause dizziness, nausea, slowed reactions. Notify crew and follow safety instructions.",
        effects_critical: "Higher risk of impaired thinking. Follow crew emergency procedures.",
        advice_ok: ["Stay seated, breathe evenly, hydrate if permitted.","If dizzy/short of breath: notify crew.","Always prioritize crew instructions."],
        advice_warn: ["Avoid unnecessary standing/movement.","Slow, steady breathing; notify crew if needed.","Prepare to follow safety instructions."],
        advice_danger: ["Stay calm, fasten seatbelt.","Notify crew immediately if symptoms are clear.","Be ready for oxygen mask if instructed."],
        advice_critical: ["Follow emergency instructions immediately.","Use oxygen mask if instructed.","Help others after you're safe."],
        techExplain: "Model: ISA (0–11 km) + pressure/alt conversion + O₂_avail ≈ P/P0 (educational simulation)",

        ui_tabs_safety: "Safety",
        ui_tabs_services: "Services",
        ui_tabs_ife: "Entertainment",
        ui_seat: "Seat",
        ui_system: "System",
        ui_time: "Time",
        ui_settings: "⚙ Settings",
        ui_cabin_params: "Cabin Parameters",
        ui_cabin_hint: "Choose: Cabin altitude or Cabin pressure",
        ui_alt: "Cabin altitude",
        ui_press: "Cabin pressure",
        ui_sim: "Simulation",
        ui_pause: "Pause",
        ui_resume: "Resume",
        ui_reset: "Reset",
        ui_stage_title: "Flight Simulation",
        ui_effects_title: "Body Effects",
        ui_effects_hint: "Impacts + guidance (simulated)",
        ui_effects_h1: "At this oxygen/pressure level, you may feel:",
        ui_effects_h2: "What you should do:",
        ui_quick_explain:
          "<b>Quick note:</b> “Available O₂” drops mainly because air pressure drops with altitude. O₂ concentration stays ~20.9%, but usable oxygen decreases.",

        ui_svc_left_title: "Services",
        ui_svc_left_hint: "Menu • order • status",
        ui_search_ph: "Search meals, drinks, keywords...",
        ui_clear: "Clear",
        ui_order_state: "Order status",
        ui_view_cart: "View cart",
        ui_confirm: "Confirm",
        ui_send: "Send to crew",
        ui_clear_order: "Clear",
        ui_note_ph: "e.g., less ice / no cheese / no onion...",
        ui_note_for_crew: "Note for crew",
        ui_svc_right_title: "Onboard menu",
        ui_svc_right_hint: "Tap item → details → add to cart → send to crew",
        ui_menu: "Menu",
        ui_showcase: "Showcase",
        ui_cart: "🛒 Cart",
        ui_step_1: "1) Pick items",
        ui_step_2: "2) Confirm",
        ui_step_3: "3) Send to crew",
        ui_policy_callout: "<b>Policy:</b> if the domain is not whitelisted, the system will <b>block</b> and log it.",

        ui_ife_launcher: "App Launcher",
        ui_ife_launcher_hint: "Only opens domains in whitelist",
        ui_player: "Inflight Player",
        ui_player_hint: "Internal video / local file (demo)",
        ui_pick_video: "Pick video",
        ui_stop: "Stop",
        ui_mode: "Mode",
        ui_drop:
          'Drag & drop a video here or click <strong>“Pick video”</strong>.<br/>(Real systems often play from an onboard server offline.)',
        ui_internal_library: "Internal library",
        ui_internal_library_hint:
          "Demo/training videos — configure in Settings → CMS (IFE library).",
        ui_theme_dark: "Theme: DARK",
        ui_theme_light: "Theme: LIGHT",

        svc_detail_title: "DETAILS",
        svc_qty: "Quantity",
        svc_add_cart: "Add to cart",
        svc_view_cart2: "🛒 View cart",

        settings_title: "Settings • CMS • Policy",
        settings_nav_seat: "Seat",
        settings_nav_cms: "CMS",
        settings_nav_security: "Security",
        settings_nav_logs: "Logs",
        settings_seat_box:
          "<b>Seat personalization</b>: stored offline (localStorage). Used for Seat ID / profile / language.",
        settings_seat_id: "Seat ID",
        settings_seat_id_ph: "e.g., 1A / 12C / VIP-01",
        settings_profile: "Passenger profile",
        settings_language: "Language",
        settings_save: "Save",
        settings_reset_seat: "Reset seat",
        settings_cms_box:
          "<b>CMS JSON</b>: Import/Export full configuration (Brand/Services/Projects/Apps/Whitelist/IFE).<br/><span class=\"mono\">Tip:</span> Import swaps the system in seconds.",
        settings_brand_title: "Brand title",
        settings_brand_sub: "Brand subtitle",
        settings_import_json: "Import JSON",
        settings_export_json: "Export JSON",
        settings_apply_brand: "Apply",
        settings_refresh_export: "Refresh",
        settings_factory: "Factory defaults",
        settings_security_box:
          "<b>Whitelist Policy</b>: only open URL when domain matches whitelist.<br/>Every open/block is recorded to Logs.",
        settings_whitelist: "Whitelist domains",
        settings_save_whitelist: "Save",
        settings_tighten: "Tighten whitelist",
        settings_security_note:
          "<b>Security note</b>: real kiosks usually add OS kiosk mode + onboard proxy layers.",
        settings_logs_box:
          "<b>Event Logs</b>: stored locally, capped at 200 entries.",
        settings_logs_refresh: "Refresh",
        settings_logs_clear: "Clear",
        settings_logs_copy: "Copy"
      }
    };

const TEXT_I18N_PAIRS = [
  { vi: "(Bản thật thường phát từ", en: "(In production these usually play from an" },
  { vi: ", thắt dây an toàn, và", en: ", fasten your seat belt, and" },
  { vi: "0 → 9,000 m (mô phỏng). Cabin thường ~ 1,800–2,500 m.", en: "0 → 9,000 m (simulated). Cabin typically ~ 1,800–2,500 m." },
  { vi: "350 → 1013 hPa (mô phỏng). 1013 hPa ≈ mực nước biển.", en: "350 → 1013 hPa (simulated). 1013 hPa ≈ sea‑level pressure." },
  { vi: ": Import/Export toàn bộ cấu hình (Brand/Services/Projects/Apps/Whitelist/IFE).", en: ": Import/Export all configuration (Brand/Services/Projects/Apps/Whitelist/IFE)." },
  { vi: ": chỉ cho phép mở URL nếu domain match whitelist.", en: ": only allow URLs whose domain matches the whitelist." },
  { vi: ": kiosk thật thường dùng thêm layer hệ điều hành (kiosk mode) + proxy nội bộ.", en: ": real kiosks usually add an OS kiosk mode and internal proxy." },
  { vi: ": lưu local, giới hạn 200 entries.", en: ": stored locally, limited to 200 entries." },
  { vi: ": lưu offline (localStorage). Dùng để hiển thị Seat ID / profile / language.", en: ": stored offline (localStorage). Used to show Seat ID / profile / language." },
  { vi: "Bấm “Xác nhận” trước, sau đó “Gửi tiếp viên” để mô phỏng quy trình 3 bước.", en: "Click “Confirm” first, then “Send to crew” to simulate the three‑step flow." },
  { vi: "Chính sách:", en: "Policy:" },
  { vi: "Danh mục", en: "Category" },
  { vi: "Giải thích nhanh:", en: "Quick note:" },
  { vi: "Gợi ý:", en: "Tip:" },
  { vi: "Hành trình", en: "Cruise" },
  { vi: "Import là “đổi hệ thống” trong 3 giây.", en: "Import is like “switching systems” in three seconds." },
  { vi: "Kéo-thả file video vào đây hoặc bấm", en: "Drag and drop a video file here or click" },
  { vi: "Model: ISA (0–11 km) + quy đổi áp suất/độ cao + O₂_avail ≈ P/P0", en: "Model: ISA (0–11 km) + pressure/altitude conversion + O₂_avail ≈ P/P0" },
  { vi: "Mỗi lần mở / bị chặn sẽ ghi vào Logs.", en: "Every open / block is written to Logs." },
  { vi: "NHÁP", en: "DRAFT" },
  { vi: "Ngoài trời", en: "Outside" },
  { vi: "Nguyên tắc vàng:", en: "Golden rule:" },
  { vi: "Nếu có cảnh báo áp suất/oxy —", en: "If there is a pressure/oxygen alert —" },
  { vi: "O₂ khả dụng", en: "Available O₂" },
  { vi: "O₂ tương đương", en: "Equivalent O₂" },
  { vi: "So với mực nước biển (ước tính theo áp suất).", en: "Compared with sea level (estimated from pressure)." },
  { vi: "Thường là ít ảnh hưởng ở phần lớn hành khách. Một số người nhạy cảm có thể hơi mệt/khó chịu nhẹ.", en: "Usually little effect for most passengers. Some sensitive people may feel slightly tired or uncomfortable." },
  { vi: "Tốc độ", en: "Speed" },
  { vi: "Từ slider / mô phỏng ISA.", en: "From the slider / ISA simulation." },
  { vi: "Từ slider / quy đổi áp suất.", en: "From the slider / pressure conversion." },
  { vi: "chặn", en: "block" },
  { vi: "giảm theo độ cao. Nồng độ O₂ vẫn ~20.9%, nhưng “lượng O₂ hữu ích” giảm.", en: "as altitude increases. O₂ concentration stays ~20.9%, but the “useful O₂” amount decreases." },
  { vi: "làm theo hướng dẫn tiếp viên", en: "follow crew instructions" },
  { vi: "nếu domain không nằm trong whitelist, hệ thống sẽ", en: "if a domain isn’t on the whitelist, the system will" },
  { vi: "server nội bộ", en: "an internal server" },
  { vi: "và ghi log.", en: "and write a log entry." },
  { vi: "áp suất", en: "pressure" },
  { vi: "đeo mặt nạ oxy khi được yêu cầu", en: "put on the oxygen mask when instructed" },
  { vi: "để offline.)", en: "for offline use.)" },
  { vi: "“Chọn video”", en: "“Select video”" },
  { vi: "“Cảm giác” tương đương nồng độ O₂ ở mực nước biển.", en: "“Feeling” equivalent to O₂ concentration at sea level." },
  { vi: "“O₂ khả dụng” giảm chủ yếu vì", en: "“Available O₂” drops mainly because" }
];


const TEXT_I18N_LOOKUP = {};
TEXT_I18N_PAIRS.forEach(p => {
  TEXT_I18N_LOOKUP[p.vi] = p;
  TEXT_I18N_LOOKUP[p.en] = p;
});

function applyI18NTextNodes(lang) {
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
  let node;
  while ((node = walker.nextNode())) {
    const raw = node.textContent.trim();
    if (!raw) continue;
    const entry = TEXT_I18N_LOOKUP[raw];
    if (entry && entry[lang]) {
      node.textContent = entry[lang];
    }
  }
}




    // ---------- State ----------
    const state = {
      autoT0: 0,
      lang: "vi",
      isAdmin: false,
      isAdmin: false,
      tab: "safety",
      mode: "alt",
      sim: "auto",
      paused: false,
      theme: "dark", // "dark" | "light"
      cabinAlt_m: 2400,
      cabinPress_hPa: 750,
      t: 0,
      cruise: true,
      speed_kmh: 840,
      oat_C: -45,
      level: "ok",
      config: loadConfig(),
      seat: { id: "—", profile: "adult" },
      svcCat: "meals",
      currentVideoBlob: null 
    };

    function t(key){ return I18N[state.lang][key]; }
    function pickLang(v){
      if(v == null) return "";
      if(typeof v === "object") return v[state.lang] ?? v.vi ?? v.en ?? "";
      return String(v);
    }

    // ---------- Seat load/save ----------
    function loadSeat(){
      try{
        const raw = localStorage.getItem(KEY.seat);
        if(!raw) return;
        const s = JSON.parse(raw);
        state.seat.id = s.id ?? state.seat.id;
        state.seat.profile = s.profile ?? state.seat.profile;
        if(s.lang && (s.lang === "vi" || s.lang === "en")) state.lang = s.lang;
        if(s.theme && (s.theme === "dark" || s.theme === "light")) state.theme = s.theme;
      }catch{}
    }
    function saveSeat(){
      localStorage.setItem(KEY.seat, JSON.stringify({
        id: state.seat.id,
        profile: state.seat.profile,
        lang: state.lang,
        theme: state.theme
      }));
      pushLog("seat_saved", { id: state.seat.id, profile: state.seat.profile, lang: state.lang });
    }
    function seatKey(){ return String(state.seat.id || "—").toUpperCase(); }

    // ---------- Orders ----------
    function getAllOrders(){ try{ return JSON.parse(localStorage.getItem(KEY.orders) || "{}"); }catch{ return {}; } }
    function saveAllOrders(obj){ localStorage.setItem(KEY.orders, JSON.stringify(obj)); }
    function loadOrder(){
      const all = getAllOrders();
      const k = seatKey();
      return all[k] || { seat:k, status:"draft", items:[], note:"", updatedAt: nowISO() };
    }
    function saveOrder(order){
      const all = getAllOrders();
      const k = seatKey();
      all[k] = { ...order, seat:k, updatedAt: nowISO() };
      saveAllOrders(all);
    }
    function orderTotals(order){
      const sum = (order.items||[]).reduce((acc,it)=>acc + (it.priceVnd*it.qty), 0);
      const qty = (order.items||[]).reduce((acc,it)=>acc + it.qty, 0);
      return { sum, qty };
    }
    function fmtMoney(vnd){
      const n = Number(vnd||0);
      return state.lang === "vi" ? `${Math.round(n).toLocaleString("vi-VN")}₫` : `$${(n/25000).toFixed(2)} (est.)`;
    }

    // ---------- DOM refs ----------
    const el = {
      clock: $("#clock"),
      sysDot: $("#sysDot"),
      sysState: $("#sysState"),
      seatLabel: $("#seatLabel"),
      profileLabel: $("#profileLabel"),
      brandTitle: $("#brandTitle"),
      brandSub: $("#brandSub"),
      tabBtns: $$(".tabbtn"),
      views: { safety: $("#view-safety"), projects: $("#view-projects"), ife: $("#view-ife") },
      modeAlt: $("#modeAlt"), modePress: $("#modePress"),
      altRange: $("#altRange"), pressRange: $("#pressRange"),
      altLabel: $("#altLabel"), pressLabel: $("#pressLabel"),
      kpiAlt: $("#kpiAlt"), kpiPress: $("#kpiPress"),
      o2Avail: $("#o2Avail"), o2Eq: $("#o2Eq"),
      statusBadge: $("#statusBadge"), statusText: $("#statusText"),
      simLabel: $("#simLabel"),
      hudCruise: $("#hudCruise"), hudSpeed: $("#hudSpeed"), hudOat: $("#hudOat"),
      hudCabAlt: $("#hudCabAlt"), hudCabPress: $("#hudCabPress"), hudO2: $("#hudO2"),
      overlay: $("#overlayAlert"), overlayTitle: $("#overlayTitle"), overlayMetric: $("#overlayMetric"),
      overlayText: $("#overlayText"), overlaySteps: $("#overlaySteps"), ovToggle: $("#ovToggle"),
      effectsText: $("#effectsText"), adviceList: $("#adviceList"), techExplain: $("#techExplain"), stageSub: $("#stageSub"),
      btnSim: $("#btnSim"), btnPause: $("#btnPause"), btnReset: $("#btnReset"), btnLang: $("#btnLang"),
      btnTheme: $("#btnTheme"),
      svcSearch: $("#svcSearch"), btnClearSvcSearch: $("#btnClearSvcSearch"),
      svcPills: $("#svcPills"), svcActive: $("#svcActive"), svcGrid: $("#svcGrid"),
      entBtnMenu: $("#entBtnMenu"), entBtnShowcase: $("#entBtnShowcase"),
      menuWrap: $("#menuWrap"), showcaseWrap: $("#showcaseWrap"), projCards: $("#projCards"),
      entCatTitle: $("#entCatTitle"), entCatHint: $("#entCatHint"), entStepper: $("#entStepper"),
      entSeatMini: $("#entSeatMini"), entCartBtn: $("#entCartBtn"), entCartCount: $("#entCartCount"),
      orderStateVal: $("#orderStateVal"), orderStateSub: $("#orderStateSub"),
      btnViewCart: $("#btnViewCart"), btnConfirmOrder: $("#btnConfirmOrder"),
      btnSendOrder: $("#btnSendOrder"), btnClearOrder: $("#btnClearOrder"), orderNote: $("#orderNote"),
      svcMask: $("#svcMask"), svcClose: $("#svcClose"), svcSeat: $("#svcSeat"),
      svcImg: $("#svcImg"), svcName: $("#svcName"), svcDesc: $("#svcDesc"),
      svcTags: $("#svcTags"), svcExtra: $("#svcExtra"),
      qtyMinus: $("#qtyMinus"), qtyPlus: $("#qtyPlus"), qtyVal: $("#qtyVal"),
      svcItemNote: $("#svcItemNote"), svcAdd: $("#svcAdd"), svcViewCart: $("#svcViewCart"),
      appGrid: $("#appGrid"), btnPickVideo: $("#btnPickVideo"), btnStopVideo: $("#btnStopVideo"),
      fileVideo: $("#fileVideo"), video: $("#video"), drop: $("#drop"),
      ifeMode: $("#ifeMode"), mediaCount: $("#mediaCount"), mediaBtns: $("#mediaBtns"),
      canvas: $("#sky"),
      btnSettings: $("#btnSettings"), modalMask: $("#modalMask"), btnCloseSettings: $("#btnCloseSettings"),
      navItems: $$(".navItem"), paneSeat: $("#paneSeat"), paneCMS: $("#paneCMS"),
      paneSecurity: $("#paneSecurity"), paneLogs: $("#paneLogs"), storageState: $("#storageState"),
      seatIdInput: $("#seatIdInput"), profileInput: $("#profileInput"), langInput: $("#langInput"),
      btnSaveSeat: $("#btnSaveSeat"), btnResetSeat: $("#btnResetSeat"),
      brandTitleInput: $("#brandTitleInput"), brandSubInput: $("#brandSubInput"),
      configFile: $("#configFile"), configPreview: $("#configPreview"),
      btnApplyBrand: $("#btnApplyBrand"), btnExport: $("#btnExport"), btnFactory: $("#btnFactory"),
      whitelistInput: $("#whitelistInput"), btnSaveWhitelist: $("#btnSaveWhitelist"), btnTighten: $("#btnTighten"),
      btnRefreshLogs: $("#btnRefreshLogs"), btnClearLogs: $("#btnClearLogs"), btnCopyLogs: $("#btnCopyLogs"), logsBox: $("#logsBox")
    };

    // ---------- Helpers ----------
    function escapeHtml(str){
      if (str == null) return "";
      return String(str)
        .replaceAll("&","&amp;") // FIX
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }
    function formatInt(n){ return Math.round(n).toLocaleString("en-US"); }
    function format1(n){ return (Math.round(n*10)/10).toFixed(1); }

    function debounce(fn, ms) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), ms);
      };
    }

    // ---------- Tabs ----------
    function setTab(tab){
      state.tab = tab;
      el.tabBtns.forEach(b => {
        const active = b.dataset.tab === tab;
        b.dataset.active = active ? "true" : "false";
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      Object.entries(el.views).forEach(([k,view]) => view.classList.toggle("active", k === tab));
      location.hash = tab;
      pushLog("tab_switch", { tab });
    }
    function initHash(){
      const h = (location.hash || "#safety").replace("#","");
      if(["safety","projects","ife"].includes(h)) setTab(h);
    }

    // ---------- Mode switch ----------
    function setMode(mode){
      state.mode = mode;
      const alt = mode === "alt";

      el.modeAlt.setAttribute("aria-pressed", alt ? "true" : "false");
      el.modePress.setAttribute("aria-pressed", alt ? "false" : "true");

      el.altRange.disabled = !alt;
      el.pressRange.disabled = alt;

      el.altRange.style.opacity = alt ? "1" : ".45";
      el.pressRange.style.opacity = alt ? ".45" : "1";

      // ✅ FIX: đổi mode thì sync ngay theo slider đang active để không bị “nhảy”
      if (alt) {
        syncFromAltitude(parseFloat(el.altRange.value));
      } else {
        syncFromPressure(parseFloat(el.pressRange.value));
      }

      renderSafety();
      pushLog("input_mode", { mode });
    }

    // ---------- Sim mode ----------
    
    function setSim(sim){
      state.sim = sim;
      const isAuto = sim === "auto";
      const label = isAuto ? t("ui_sim_auto") : t("ui_sim_manual");
      el.btnSim.textContent = label;
      el.simLabel.textContent = label;
      pushLog("sim_mode", { sim });
    }


    // ---------- Cabin model ----------
    const ISA = { P0: 1013.25, T0: 288.15, L: 0.0065, g: 9.80665, R: 287.05287 };
    function pressureFromAltitude_m(h){
      const {P0,T0,L,g,R} = ISA;
      const x = 1 - (L*h)/T0;
      const exp = g/(R*L);
      return P0 * Math.pow(clamp(x, 0.0001, 1), exp);
    }
    function altitudeFromPressure_hPa(P){
      const {P0,T0,L,g,R} = ISA;
      const exp = (R*L)/g;
      const ratio = clamp(P/P0, 0.0001, 1.2);
      const x = Math.pow(ratio, exp);
      return (T0/L) * (1 - x);
    }
    function oxygenAvailability(P_hPa){
      const ratio = clamp(P_hPa / ISA.P0, 0, 1.2);
      const avail = ratio * 100;
      const eqO2 = 20.9 * ratio;
      return { ratio, avail, eqO2 };
    }
    const THRESH = { ok:{altMax:2500}, warn:{altMax:3500}, danger:{altMax:4500}, critical:{altMax:Infinity} };
    function levelFromAlt(alt_m){
      if(alt_m <= THRESH.ok.altMax) return "ok";
      if(alt_m <= THRESH.warn.altMax) return "warn";
      if(alt_m <= THRESH.danger.altMax) return "danger";
      return "critical";
    }

    // ---------- Cabin sync ----------
    function syncFromAltitude(alt_m){
      state.cabinAlt_m = clamp(alt_m, 0, 11000);
      state.cabinPress_hPa = clamp(pressureFromAltitude_m(state.cabinAlt_m), 200, 1200);
      el.pressRange.value = Math.round(state.cabinPress_hPa);
    }
    function syncFromPressure(P_hPa){
      state.cabinPress_hPa = clamp(P_hPa, 200, 1200);
      state.cabinAlt_m = clamp(altitudeFromPressure_hPa(state.cabinPress_hPa), 0, 11000);
      el.altRange.value = Math.round(state.cabinAlt_m);
    }

    // ---------- Derived UI ----------
    function statusFor(level){
      const map = {
        ok:       { badge: t("badge_ok"), class:"ok", text: t("status_ok"), overlayTitle: t("overlay_ok") },
        warn:     { badge: t("badge_warn"), class:"warn", text: t("status_warn"), overlayTitle: t("overlay_warn") },
        danger:   { badge: t("badge_danger"), class:"danger", text: t("status_danger"), overlayTitle: t("overlay_danger") },
        critical: { badge: t("badge_critical"), class:"critical", text: t("status_critical"), overlayTitle: t("overlay_critical") }
      };
      return map[level];
    }
    function overlayStepsFor(level){ return I18N[state.lang]["steps_" + level]; }
    function effectsFor(level){ return I18N[state.lang]["effects_" + level]; }
    function adviceFor(level){ return I18N[state.lang]["advice_" + level]; }

    function applyBrand(){
      el.brandTitle.textContent = state.config.brand?.title || FACTORY.brand.title;
      el.brandSub.textContent = state.config.brand?.subtitle || FACTORY.brand.subtitle;
    }
    function applySeatUI(){
      el.seatLabel.textContent = state.seat.id || "—";
      el.profileLabel.textContent = (state.seat.profile || "adult").toUpperCase();
    }
    
    
    function applyLang(){
      el.btnLang.textContent = state.lang.toUpperCase();
      el.langInput.value = state.lang;

      setSim(state.sim);
      el.btnPause.textContent = state.paused ? t("ui_resume") : t("ui_pause");

      applyI18NStatic();

      // Re-render dynamic lists that use pickLang()
      renderSvcPills();
      renderSvcGrid();
      renderMedia();
      syncOrderUI();
      applyI18NTextNodes(state.lang);
    }


    function applyTheme(){
      document.documentElement.setAttribute("data-theme", state.theme || "dark");
      if(el.btnTheme){
        el.btnTheme.textContent = (state.theme === "light") ? t("ui_theme_light") : t("ui_theme_dark");
      }
    }

    
    function applyI18NStatic(){
      document.documentElement.lang = state.lang || "vi";
      document.title = t("doc_title") || document.title;

      // Tabs: stable label span (no duplicate text nodes)
      el.tabBtns.forEach(btn => {
        const tab = btn.dataset.tab;
        const label =
          tab === "safety" ? t("ui_tabs_safety") :
          tab === "projects" ? t("ui_tabs_services") :
          t("ui_tabs_ife");

        Array.from(btn.childNodes).forEach(n => { if(n.nodeType === 3) n.textContent = ""; });

        let span = btn.querySelector(".tabLabel");
        if(!span){
          span = document.createElement("span");
          span.className = "tabLabel";
          const svg = btn.querySelector("svg");
          if(svg && svg.nextSibling) btn.insertBefore(span, svg.nextSibling);
          else btn.appendChild(span);
        }
        span.textContent = label;
        btn.setAttribute("aria-label", label);
      });

      // Top pills titles/labels
      const pills = $$(".meta .pill");
      if(pills[0]){
        pills[0].setAttribute("title", t("ui_seat_title"));
        const sp = pills[0].querySelector("span");
        if(sp) sp.textContent = t("ui_seat");
      }
      if(pills[1]){
        pills[1].setAttribute("title", t("ui_system_title"));
        const spans = pills[1].querySelectorAll("span");
        if(spans && spans[1]) spans[1].textContent = t("ui_system");
      }
      if(pills[2]){
        pills[2].setAttribute("title", t("ui_time_title"));
        const sp = pills[2].querySelector("span");
        if(sp) sp.textContent = t("ui_time");
      }

      // Settings button
      el.btnSettings.textContent = t("ui_settings");
      el.btnSettings.setAttribute("title", t("ui_settings_title"));

      // Safety headers
      const safetyLeftHeader = $("#view-safety .panel .panelHeader h2");
      const safetyLeftHint = $("#view-safety .panel .panelHeader .hint");
      if(safetyLeftHeader) safetyLeftHeader.textContent = t("ui_cabin_params");
      if(safetyLeftHint) safetyLeftHint.textContent = t("ui_cabin_hint");

      el.modeAlt.textContent = t("ui_alt");
      el.modePress.textContent = t("ui_press");

      // Avoid index-based label selection
      const altRowLabel = el.altLabel?.closest(".row")?.querySelector(".label");
      const pressRowLabel = el.pressLabel?.closest(".row")?.querySelector(".label");
      const simRowLabel = el.simLabel?.closest(".row")?.querySelector(".label");
      if(altRowLabel) altRowLabel.textContent = t("ui_alt");
      if(pressRowLabel) pressRowLabel.textContent = t("ui_press");
      if(simRowLabel) simRowLabel.textContent = t("ui_sim");

      el.btnReset.textContent = t("ui_reset");
      el.btnPause.textContent = state.paused ? t("ui_resume") : t("ui_pause");

      $("#stageTitle").textContent = t("ui_stage_title");

      $("#effectsTitle").textContent = t("ui_effects_title");
      $("#effectsHint").textContent = t("ui_effects_hint");
      $("#effectsH1").textContent = t("ui_effects_h1");
      $("#effectsH2").textContent = t("ui_effects_h2");
      $("#quickExplain").innerHTML = t("ui_quick_explain");

      el.stageSub.textContent = t("stageSub");
      el.techExplain.textContent = t("techExplain");

      if(el.btnTheme){
        el.btnTheme.textContent = (state.theme === "light") ? t("ui_theme_light") : t("ui_theme_dark");
      }

      // Services
      $("#svcLeftTitle").textContent = t("ui_svc_left_title");
      $("#svcLeftHint").textContent = t("ui_svc_left_hint");
      el.svcSearch.placeholder = t("ui_search_ph");
      el.btnClearSvcSearch.textContent = t("ui_clear");

      const orderLabel = $("#orderStatusCard .label");
      if(orderLabel) orderLabel.textContent = t("ui_order_state");
      el.btnViewCart.textContent = t("ui_view_cart");
      el.btnConfirmOrder.textContent = t("ui_confirm");
      el.btnSendOrder.textContent = t("ui_send");
      el.btnClearOrder.textContent = t("ui_clear_order");
      el.orderNote.placeholder = t("ui_note_ph");

      const orderNoteTitle = $("#orderStatusCard .small b");
      if(orderNoteTitle) orderNoteTitle.textContent = t("ui_note_for_crew");

      $("#svcRightTitle").textContent = t("ui_svc_right_title");
      $("#svcRightHint").textContent = t("ui_svc_right_hint");
      el.entBtnMenu.textContent = t("ui_menu");
      el.entBtnShowcase.textContent = t("ui_showcase");

      if(el.entCartBtn && el.entCartCount){
        const countNode = el.entCartCount;
        el.entCartBtn.textContent = "";
        el.entCartBtn.appendChild(document.createTextNode(t("ui_cart") + " "));
        el.entCartBtn.appendChild(countNode);
      }

      const s1 = $("#entStepper .step[data-step='1']");
      const s2 = $("#entStepper .step[data-step='2']");
      const s3 = $("#entStepper .step[data-step='3']");
      if(s1) s1.textContent = t("ui_step_1");
      if(s2) s2.textContent = t("ui_step_2");
      if(s3) s3.textContent = t("ui_step_3");

      // Policy callouts (best-effort)
      const policyCallouts = $$(".callout").filter(n => {
        const txt = (n.textContent || "").toLowerCase();
        return txt.includes("whitelist") || txt.includes("policy") || txt.includes("chính sách");
      });
      policyCallouts.forEach(n => { n.innerHTML = t("ui_policy_callout"); });

      // IFE
      const ifeLeftH2 = $("#view-ife .ife .panel .panelHeader h2");
      const ifeLeftHint = $("#view-ife .ife .panel .panelHeader .hint");
      if(ifeLeftH2) ifeLeftH2.textContent = t("ui_ife_launcher");
      if(ifeLeftHint) ifeLeftHint.textContent = t("ui_ife_launcher_hint");

      const playerH2 = $("#view-ife .player .panelHeader h2");
      const playerHint = $("#view-ife .player .panelHeader .hint");
      if(playerH2) playerH2.textContent = t("ui_player");
      if(playerHint) playerHint.textContent = t("ui_player_hint");

      el.btnPickVideo.textContent = t("ui_pick_video");
      el.btnStopVideo.textContent = t("ui_stop");
      const modePillLabel = $("#view-ife .playerTop .pill span");
      if(modePillLabel) modePillLabel.textContent = t("ui_mode");
      el.drop.innerHTML = t("ui_drop");

      const libLabel = el.mediaCount?.closest(".row")?.querySelector(".label");
      if(libLabel) libLabel.textContent = t("ui_internal_library");
      const mediaHint = $("#mediaHint");
      if(mediaHint) mediaHint.textContent = t("ui_internal_library_hint");

      // Service modal
      const svcModalTitle = $("#svcModalTitle");
      if(svcModalTitle) svcModalTitle.textContent = t("svc_detail_title");
      const svcClose = $("#svcClose");
      if(svcClose) svcClose.textContent = t("ui_close");
      const svcSeatLabel = $("#svcMask .svcModalTop .pill span");
      if(svcSeatLabel) svcSeatLabel.textContent = t("ui_seat");
      const qtyLabel = $("#svcMask .qtyRow .label");
      if(qtyLabel) qtyLabel.textContent = t("svc_qty");
      const svcNoteLabel = $("#svcMask .svcModalLeft .small b");
      if(svcNoteLabel) svcNoteLabel.textContent = t("ui_note_for_crew");
      const svcAdd = $("#svcAdd");
      const svcViewCart = $("#svcViewCart");
      if(svcAdd) svcAdd.textContent = t("svc_add_cart");
      if(svcViewCart) svcViewCart.textContent = t("svc_view_cart2");

      // Settings modal
      const settingsTitle = $("#settingsTitle");
      if(settingsTitle) settingsTitle.textContent = t("settings_title");
      const storagePillLabel = $("#modalMask .modalTop .pill span");
      if(storagePillLabel) storagePillLabel.textContent = t("ui_storage");
      const closeSettings = $("#btnCloseSettings");
      if(closeSettings) closeSettings.textContent = t("ui_close");

      $$(".navItem").forEach(b => {
        const p = b.dataset.pane;
        if(p === "seat") b.textContent = t("settings_nav_seat");
        if(p === "cms") b.textContent = t("settings_nav_cms");
        if(p === "security") b.textContent = t("settings_nav_security");
        if(p === "logs") b.textContent = t("settings_nav_logs");
      });

      const seatBox = $("#paneSeat .mutedBox");
      if(seatBox) seatBox.innerHTML = t("settings_seat_box");
      const seatIdLabel = $("#seatIdInput")?.closest(".field")?.querySelector("label");
      if(seatIdLabel) seatIdLabel.textContent = t("settings_seat_id");
      const seatIdInput = $("#seatIdInput");
      if(seatIdInput) seatIdInput.placeholder = t("settings_seat_id_ph");
      const profileLabel = $("#profileInput")?.closest(".field")?.querySelector("label");
      if(profileLabel) profileLabel.textContent = t("settings_profile");
      const langLabel = $("#langInput")?.closest(".field")?.querySelector("label");
      if(langLabel) langLabel.textContent = t("settings_language");
      const saveSeat = $("#btnSaveSeat");
      if(saveSeat) saveSeat.textContent = t("settings_save");
      const resetSeat = $("#btnResetSeat");
      if(resetSeat) resetSeat.textContent = t("settings_reset_seat");

      const cmsBox = $("#paneCMS .mutedBox");
      if(cmsBox) cmsBox.innerHTML = t("settings_cms_box");
      const brandTitleLabel = $("#brandTitleInput")?.closest(".field")?.querySelector("label");
      if(brandTitleLabel) brandTitleLabel.textContent = t("settings_brand_title");
      const brandSubLabel = $("#brandSubInput")?.closest(".field")?.querySelector("label");
      if(brandSubLabel) brandSubLabel.textContent = t("settings_brand_sub");
      const importLabel = $("#configFile")?.closest(".field")?.querySelector("label");
      if(importLabel) importLabel.textContent = t("settings_import_json");
      const exportLabel = $("#configPreview")?.closest(".field")?.querySelector("label");
      if(exportLabel) exportLabel.textContent = t("settings_export_json");
      const applyBrand = $("#btnApplyBrand");
      if(applyBrand) applyBrand.textContent = t("settings_apply_brand");
      const refreshExport = $("#btnExport");
      if(refreshExport) refreshExport.textContent = t("settings_refresh_export");
      const factoryBtn = $("#btnFactory");
      if(factoryBtn) factoryBtn.textContent = t("settings_factory");

      const secBox = $("#paneSecurity .mutedBox");
      if(secBox) secBox.innerHTML = t("settings_security_box");
      const wlLabel = $("#whitelistInput")?.closest(".field")?.querySelector("label");
      if(wlLabel) wlLabel.textContent = t("settings_whitelist");
      const saveWL = $("#btnSaveWhitelist");
      if(saveWL) saveWL.textContent = t("settings_save_whitelist");
      const tightenWL = $("#btnTighten");
      if(tightenWL) tightenWL.textContent = t("settings_tighten");
      const secNote = $("#paneSecurity .hr + .mutedBox");
      if(secNote) secNote.innerHTML = t("settings_security_note");

      const logsBox = $("#paneLogs .mutedBox");
      if(logsBox) logsBox.innerHTML = t("settings_logs_box");
      const logsRefresh = $("#btnRefreshLogs");
      if(logsRefresh) logsRefresh.textContent = t("settings_logs_refresh");
      const logsClear = $("#btnClearLogs");
      if(logsClear) logsClear.textContent = t("settings_logs_clear");
      const logsCopy = $("#btnCopyLogs");
      if(logsCopy) logsCopy.textContent = t("settings_logs_copy");
    }


    // ---------- Render (Safety) ----------
    function renderSafety(){
      const alt = state.cabinAlt_m;
      const P = state.cabinPress_hPa;
      const { avail, eqO2 } = oxygenAvailability(P);
      const level = levelFromAlt(alt);
      state.level = level;

      el.altLabel.textContent = `${formatInt(alt)} m`;
      el.pressLabel.textContent = `~ ${formatInt(P)} hPa`;
      el.kpiAlt.textContent = `${formatInt(alt)} m`;
      el.kpiPress.textContent = `~ ${formatInt(P)} hPa`;
      el.o2Avail.textContent = `~ ${formatInt(avail)}%`;
      el.o2Eq.textContent = `~ ${format1(eqO2)}%`;

      el.hudCruise.textContent = state.cruise ? "ON" : "OFF";
      el.hudSpeed.textContent = `~ ${formatInt(state.speed_kmh)} km/h`;
      el.hudOat.textContent = `${state.oat_C > 0 ? "+" : ""}${formatInt(state.oat_C)}°C`;
      el.hudCabAlt.textContent = `${formatInt(alt)} m`;
      el.hudCabPress.textContent = `${formatInt(P)} hPa`;
      el.hudO2.textContent = `${formatInt(avail)}%`;

      const s = statusFor(level);
      el.statusBadge.textContent = s.badge;
      el.statusBadge.className = `badge ${s.class}`;
      el.statusText.textContent = s.text;

      el.overlay.dataset.level = level;
      el.overlayTitle.textContent = s.overlayTitle;
      el.overlayMetric.textContent = `O₂ ~ ${formatInt(avail)}%`;
      el.overlaySteps.innerHTML = overlayStepsFor(level).map(x => `<li>${escapeHtml(x)}</li>`).join("");

      const overlayText = (level === "ok") 
        ? (state.lang === "vi" ? "Cabin đang trong vùng an toàn mô phỏng." : "Cabin is within the simulated safe zone.")
        : (level === "warn") 
        ? (state.lang === "vi" ? "Cabin đang vào vùng cần chú ý." : "Cabin is entering a caution zone.")
        : (level === "danger")
        ? (state.lang === "vi" ? "Cabin đang ở mức cảnh báo." : "Cabin is in a warning zone.")
        : (state.lang === "vi" ? "Cabin ở mức khẩn cấp." : "Cabin is critical.");
      
      el.overlayText.textContent = overlayText;
      el.effectsText.textContent = effectsFor(level);
      el.adviceList.innerHTML = adviceFor(level).map(x => `<li>${escapeHtml(x)}</li>`).join("");

      el.sysDot.style.background =
        level === "ok" ? "var(--ok)" :
        level === "warn" ? "var(--warn)" :
        level === "danger" ? "var(--danger)" : "var(--critical)";
      el.sysState.textContent =
        level === "ok" ? "READY" :
        level === "warn" ? "CAUTION" :
        level === "danger" ? "WARNING" : "CRITICAL";
    }

    // ---------- Toast ----------
    let toastTimer = null;
    const TOAST_I18N = {
  "AUTO: OFF": { vi: "AUTO: TẮT", en: "AUTO: OFF" },
  "AUTO: ON": { vi: "AUTO: BẬT", en: "AUTO: ON" },
  "Blocked: Invalid protocol": { vi: "Bị chặn: Giao thức không hợp lệ.", en: "Blocked: Invalid protocol" },
  "Bị chặn bởi policy (whitelist).": { vi: "Bị chặn bởi policy (whitelist).", en: "Blocked by policy (whitelist)." },
  "Chưa có món nào.": { vi: "Chưa có món nào.", en: "No items yet." },
  "Copied": { vi: "Đã copy.", en: "Copied" },
  "Copy failed": { vi: "Copy thất bại.", en: "Copy failed" },
  "Giỏ trống.": { vi: "Giỏ trống.", en: "Cart is empty." },
  "Hãy bấm “Xác nhận” trước.": { vi: "Hãy bấm “Xác nhận” trước.", en: "Please click “Confirm” first." },
  "Import thất bại (JSON lỗi).": { vi: "Import thất bại (JSON lỗi).", en: "Import failed (invalid JSON)." },
  "Link nội bộ (#) — hãy thay URL thật trong CMS.": { vi: "Link nội bộ (#) — hãy thay URL thật trong CMS.", en: "Internal link (#) — please replace with a real URL in the CMS." },
  "Media URL thiếu trong CMS.": { vi: "Media URL thiếu trong CMS.", en: "Media URL is missing in the CMS." },
  "Media bị chặn bởi whitelist.": { vi: "Media bị chặn bởi whitelist.", en: "Media blocked by whitelist." },
  "Reset": { vi: "Reset", en: "Reset" },
  "Stopped": { vi: "Đã dừng.", en: "Stopped" },
  "URL không hợp lệ.": { vi: "URL không hợp lệ.", en: "Invalid URL." },
  "Đã gửi (mô phỏng)": { vi: "Đã gửi (mô phỏng).", en: "Sent (simulated)." },
  "Đã import config": { vi: "Đã import config.", en: "Configuration imported." },
  "Đã khôi phục mặc định": { vi: "Đã khôi phục mặc định.", en: "Defaults restored." },
  "Đã làm mới export": { vi: "Đã làm mới export.", en: "Export refreshed." },
  "Đã làm mới log": { vi: "Đã làm mới log.", en: "Log refreshed." },
  "Đã lưu ghế": { vi: "Đã lưu ghế.", en: "Seat preferences saved." },
  "Đã lưu whitelist": { vi: "Đã lưu whitelist.", en: "Whitelist saved." },
  "Đã reset ghế": { vi: "Đã reset ghế.", en: "Seat preferences reset." },
  "Đã siết whitelist": { vi: "Đã siết whitelist.", en: "Whitelist tightened." },
  "Đã thêm vào giỏ": { vi: "Đã thêm vào giỏ.", en: "Added to cart." },
  "Đã xác nhận": { vi: "Đã xác nhận.", en: "Confirmed." },
  "Đã xóa log": { vi: "Đã xóa log.", en: "Log cleared." },
  "Đã xóa đơn": { vi: "Đã xóa đơn.", en: "Order cleared." },
  "Đã áp dụng brand": { vi: "Đã áp dụng brand.", en: "Brand applied." }
};


function translateToast(msg) {
  const entry = TOAST_I18N[msg];
  if (!entry) return msg;
  return state.lang === "vi" ? entry.vi : entry.en;
}

function toast(msg){
      let node = $("#toast");
      if(!node){
        node = document.createElement("div");
        node.id = "toast";
        node.style.position = "fixed";
        node.style.left = "50%";
        node.style.bottom = "24px";
        node.style.transform = "translateX(-50%)";
        node.style.padding = "12px 14px";
        node.style.borderRadius = "999px";
        node.style.border = "1px solid rgba(255,255,255,.14)";
        node.style.background = "rgba(0,0,0,.30)";
        node.style.backdropFilter = "blur(12px)";
        node.style.boxShadow = "0 14px 40px rgba(0,0,0,.45)";
        node.style.color = "rgba(233,238,252,.95)";
        node.style.fontWeight = "900";
        node.style.letterSpacing = ".02em";
        node.style.zIndex = 9999;
        node.style.opacity = "0";
        node.style.transition = "opacity .18s ease, transform .18s ease";
        document.body.appendChild(node);
      }
      node.textContent = msg;
      node.style.opacity = "1";
      node.style.transform = "translateX(-50%) translateY(-2px)";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        node.style.opacity = "0";
        node.style.transform = "translateX(-50%) translateY(6px)";
      }, 1400);
    }



    // ---------- Admin UI Login (Injected) ----------
    const ADMIN_PASS = "1811"; // change if needed

    function adminMaskEls(){
      return {
        mask: document.getElementById("adminMask"),
        pass: document.getElementById("adminPassInput"),
        err:  document.getElementById("adminError"),
        close: document.getElementById("adminCloseBtn"),
        cancel: document.getElementById("adminCancelBtn"),
        unlock: document.getElementById("adminUnlockBtn"),
        title: document.getElementById("adminTitle"),
        hint: document.getElementById("adminHint"),
        label: document.getElementById("adminPassLabel")
      };
    }

    function adminI18N(){
      const isVI = state.lang === "vi";
      const E = adminMaskEls();
      if(!E.title) return;
      E.title.textContent = isVI ? "Truy cập Admin" : "Admin Access";
      E.hint.innerHTML = isVI
        ? "<b>Giới hạn</b>: CMS / Whitelist / Logs chỉ dành cho tiếp viên/admin."
        : "<b>Restricted</b>: CMS / Whitelist / Logs are for crew/admin only.";
      E.label.textContent = isVI ? "Mật khẩu" : "Password";
      E.pass.placeholder = "••••";
      E.close.textContent = isVI ? "Đóng" : "Close";
      E.cancel.textContent = isVI ? "Hủy" : "Cancel";
      E.unlock.textContent = isVI ? "Mở khóa" : "Unlock";
      E.err.textContent = isVI ? "Sai mật khẩu." : "Invalid password.";
    }

    function showAdminLogin(onSuccess){
      const E = adminMaskEls();
      if(!E.mask) {
        toast(state.lang === "vi" ? "Thiếu panel admin (HTML)." : "Admin panel missing (HTML).");
        return;
      }

      adminI18N();
      E.err.style.display = "none";
      E.pass.value = "";

      E.mask.classList.add("show");
      E.mask.setAttribute("aria-hidden","false");
      setTimeout(() => E.pass.focus(), 50);

      const close = () => {
        E.mask.classList.remove("show");
        E.mask.setAttribute("aria-hidden","true");
      };

      const submit = () => {
        const v = (E.pass.value || "").trim();
        if(v === ADMIN_PASS){
          state.isAdmin = true;
          sessionStorage.setItem("aero.admin","1");
          pushLog("admin_login_ok", {});
          close();
          if(typeof onSuccess === "function") onSuccess();
          toast(state.lang === "vi" ? "Đã mở khóa admin" : "Admin unlocked");
        } else {
          E.err.style.display = "block";
          pushLog("admin_login_fail", { len: v.length });
        }
      };

      E.close.onclick = close;
      E.cancel.onclick = close;
      E.unlock.onclick = submit;
      E.mask.onclick = (ev) => { if(ev.target === E.mask) close(); };
      E.pass.onkeydown = (ev) => { if(ev.key === "Enter") { ev.preventDefault(); submit(); } };
    }

    // ---------- Clock ----------
    function updateClock(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      el.clock.textContent = `${hh}:${mm}:${ss}`;
    }

    // ---------- Simulation engine ----------
      // ===== AUTO ENGINE (triangle wave like your poster demo) =====
  const AUTO = {
    T: 24000,                 // 24s / cycle
    altMin: 0,
    altMax: 9000,             // match altRange max
    pressMin: 350,            // match pressRange min
    pressMax: 1013            // match pressRange max
  };

  // time->triangle [0..1..0]
  function tri01(nowMs, t0Ms, T){
    const phase = ((nowMs - t0Ms) % T + T) % T;
    const p = phase / T;                  // 0..1
    return (p < 0.5) ? (p * 2) : (1 - (p - 0.5) * 2);
  }

  // align t0 so that current value continues smoothly
  function setAutoT0FromCurrent(){
    const now = state.t; // state.t is our running clock (ms)
    let tri = 0;

    if (state.mode === "alt") {
      const alt = clamp(state.cabinAlt_m, AUTO.altMin, AUTO.altMax);
      const percent = (alt - AUTO.altMin) / (AUTO.altMax - AUTO.altMin); // 0..1
      // tri is 0..1..0; mapping in poster uses t0 = now - currentPercent*T/2
      state.autoT0 = now - (percent * AUTO.T / 2);
    } else {
      const P = clamp(state.cabinPress_hPa, AUTO.pressMin, AUTO.pressMax);
      const percent = (P - AUTO.pressMin) / (AUTO.pressMax - AUTO.pressMin);
      state.autoT0 = now - (percent * AUTO.T / 2);
    }
  }
    function tick(dt){
      if(state.paused) return;
      state.t += dt;

      const wob = Math.sin(state.t*0.0012);
      const wob2 = Math.sin(state.t*0.0007 + 1.2);
      state.speed_kmh = 840 + wob*14 + wob2*8;
      state.oat_C = -45 + wob2*2 - wob*1.2;

      if (state.sim === "auto") {
        const tri = tri01(state.t, state.autoT0 || 0, AUTO.T); // 0..1..0

        if (state.mode === "alt") {
          const alt = AUTO.altMin + tri * (AUTO.altMax - AUTO.altMin);
          // keep slider in sync with auto value
          el.altRange.value = Math.round(alt);
          syncFromAltitude(parseFloat(el.altRange.value));
        } else {
          const P = AUTO.pressMin + tri * (AUTO.pressMax - AUTO.pressMin);
          el.pressRange.value = Math.round(P);
          syncFromPressure(parseFloat(el.pressRange.value));
        }
      }
    }

    // ---------- Canvas ----------
    const ctx = el.canvas.getContext("2d");
    let DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    let stars = [];
    const fontMono = "ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    const fontSans = "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";

    function resizeCanvas(){
      const r = el.canvas.getBoundingClientRect();
      el.canvas.width = Math.floor(r.width * DPR);
      el.canvas.height = Math.floor(r.height * DPR);
      seedStars();
    }
    window.addEventListener("resize", () => {
      DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      resizeCanvas();
    });
    function seedStars(){
      const w = el.canvas.width, h = el.canvas.height;
      stars = [];
      const n = Math.floor((w*h) / 45000);
      for(let i=0;i<n;i++){
        stars.push({
          x: Math.random()*w,
          y: Math.random()*h*0.65,
          r: Math.random()*1.6 + 0.2,
          a: Math.random()*0.6 + 0.2,
          tw: Math.random()*0.9 + 0.1
        });
      }
    }
    function lerp(a,b,t){ return a + (b-a)*t; }
    function quadBezierY(t, y0, y1, y2){
      const inv = 1-t;
      return inv*inv*y0 + 2*inv*t*y1 + t*t*y2;
    }
    function drawAircraft(x,y,u){
      const w = el.canvas.width, h = el.canvas.height;
      const du = 0.01;
      const arcY = h*0.58;
      const yA = quadBezierY(clamp(u-du,0,1), arcY, h*0.34, arcY);
      const yB = quadBezierY(clamp(u+du,0,1), arcY, h*0.34, arcY);
      const dx = lerp(w*0.10, w*0.90, u+du) - lerp(w*0.10, w*0.90, u-du);
      const dy = yB - yA;
      const ang = Math.atan2(dy, dx);

      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(ang);

      ctx.globalAlpha = .98;
      ctx.fillStyle = "rgba(233,238,252,.90)";
      ctx.strokeStyle = "rgba(0,0,0,.28)";
      ctx.lineWidth = 1.4*DPR;

      ctx.beginPath();
      ctx.moveTo(-22*DPR, 0);
      ctx.quadraticCurveTo(0, -10*DPR, 28*DPR, 0);
      ctx.quadraticCurveTo(0, 10*DPR, -22*DPR, 0);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      ctx.fillStyle = "rgba(233,238,252,.82)";
      ctx.beginPath();
      ctx.moveTo(-2*DPR, 0);
      ctx.lineTo(-18*DPR, -18*DPR);
      ctx.lineTo(6*DPR, -4*DPR);
      ctx.closePath();
      ctx.fill();

      ctx.beginPath();
      ctx.moveTo(-2*DPR, 0);
      ctx.lineTo(-18*DPR, 18*DPR);
      ctx.lineTo(6*DPR, 4*DPR);
      ctx.closePath();
      ctx.fill();

      ctx.fillStyle = "rgba(233,238,252,.75)";
      ctx.beginPath();
      ctx.moveTo(-14*DPR, 0);
      ctx.lineTo(-24*DPR, -10*DPR);
      ctx.lineTo(-12*DPR, -6*DPR);
      ctx.closePath();
      ctx.fill();

      ctx.restore();
      ctx.globalAlpha = 1;
    }
    function drawGauge(w,h){
      const cx = w*0.5, cy = h*0.62;
      const r0 = Math.min(w,h) * 0.23;

      const P = state.cabinPress_hPa;
      const alt = state.cabinAlt_m;
      const { avail } = oxygenAvailability(P);

      ctx.save();
      ctx.translate(cx,cy);

      ctx.globalAlpha = .95;
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 14*DPR;
      ctx.beginPath();
      ctx.arc(0,0,r0, Math.PI*0.95, Math.PI*2.05);
      ctx.stroke();

      const stress = clamp(alt/5000, 0, 1);
      const start = Math.PI*0.95;
      const end = start + (Math.PI*1.1) * stress;

      const col =
        state.level === "ok" ? "rgba(110,231,183,.70)" :
        state.level === "warn" ? "rgba(251,191,36,.72)" :
        state.level === "danger" ? "rgba(251,113,133,.75)" :
        "rgba(244,63,94,.80)";

      ctx.strokeStyle = col;
      ctx.lineWidth = 14*DPR;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.arc(0,0,r0, start, end);
      ctx.stroke();

      const ig = ctx.createRadialGradient(0,-r0*0.4, 10, 0,0, r0*1.3);
      ig.addColorStop(0, "rgba(255,255,255,.10)");
      ig.addColorStop(1, "rgba(0,0,0,.25)");
      ctx.fillStyle = ig;
      ctx.beginPath();
      ctx.arc(0,0,r0*0.78, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = .95;
      ctx.fillStyle = "rgba(233,238,252,.92)";
      ctx.font = `900 ${Math.floor(18*DPR)}px ${fontMono}`;
      ctx.textAlign = "center";
      ctx.fillText(`${Math.round(avail)}% O₂`, 0, -4*DPR);

      ctx.font = `800 ${Math.floor(12*DPR)}px ${fontSans}`;
      ctx.fillStyle = "rgba(169,179,214,.95)";
      ctx.fillText(`Cabin ${Math.round(alt)} m • ${Math.round(P)} hPa`, 0, 18*DPR);

      ctx.restore();
      ctx.globalAlpha = 1;
    }
    function draw(){
        if(document.hidden) {
          requestAnimationFrame(draw);
        return;
      }

      const w = el.canvas.width, h = el.canvas.height;
      ctx.clearRect(0,0,w,h);

      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0, "rgba(8,10,18,1)");
      g.addColorStop(0.55, "rgba(10,14,26,1)");
      g.addColorStop(1, "rgba(7,8,14,1)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      const hg = ctx.createRadialGradient(w*0.5,h*0.62, 10, w*0.5,h*0.62, w*0.9);
      hg.addColorStop(0, (state.theme==="light") ? "rgba(34,211,238,.06)" : "rgba(139,92,246,.10)");
      hg.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = hg;
      ctx.fillRect(0,0,w,h);

      for(const s of stars){
        const tw = 0.5 + 0.5*Math.sin(state.t*0.001*s.tw + s.x*0.01);
        ctx.globalAlpha = s.a * (0.6 + 0.4*tw);
        ctx.fillStyle = "rgba(233,238,252,1)";
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r*DPR, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;

      const cloudAlpha = (state.theme==="light") ? 0.10 : 0.14;
      for(let i=0;i<6;i++){
        const px = (w*0.12) + i*(w*0.16) + Math.sin(state.t*0.0005 + i)*35*DPR;
        const py = h*0.70 + Math.sin(state.t*0.0007 + i*1.7)*18*DPR;
        const cg = ctx.createRadialGradient(px,py, 10, px,py, 180*DPR);
        cg.addColorStop(0, `rgba(255,255,255,${cloudAlpha})`);
        cg.addColorStop(1, "rgba(255,255,255,0)");
        ctx.fillStyle = cg;
        ctx.fillRect(px-220*DPR, py-120*DPR, 440*DPR, 240*DPR);
      }

      const arcY = h*0.58;
      ctx.globalAlpha = .30;
      ctx.strokeStyle = (state.theme==="light") ? "rgba(34,211,238,.28)" : "rgba(139,92,246,.35)";
      ctx.lineWidth = 2*DPR;
      ctx.beginPath();
      ctx.moveTo(w*0.10, arcY);
      ctx.quadraticCurveTo(w*0.50, h*0.34, w*0.90, arcY);
      ctx.stroke();
      ctx.globalAlpha = 1;

      const u = (0.5 + 0.5*Math.sin(state.t*0.00028));
      const ax = lerp(w*0.10, w*0.90, u);
      const ay = quadBezierY(u, arcY, h*0.34, arcY);

      const glow =
        state.level === "ok" ? "rgba(110,231,183,.25)" :
        state.level === "warn" ? "rgba(251,191,36,.28)" :
        state.level === "danger" ? "rgba(251,113,133,.30)" :
        "rgba(244,63,94,.32)";

      const ag = ctx.createRadialGradient(ax,ay, 10*DPR, ax,ay, 120*DPR);
      ag.addColorStop(0, glow);
      ag.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = ag;
      ctx.fillRect(ax-130*DPR, ay-130*DPR, 260*DPR, 260*DPR);

      drawAircraft(ax, ay, u);
      drawGauge(w, h);

      ctx.globalAlpha = .9;
      const vg = ctx.createRadialGradient(w*0.5,h*0.55, w*0.15, w*0.5,h*0.55, w*0.8);
      vg.addColorStop(0, "rgba(0,0,0,0)");
      vg.addColorStop(1, "rgba(0,0,0,.55)");
      ctx.fillStyle = vg;
      ctx.fillRect(0,0,w,h);
      ctx.globalAlpha = 1;
    }

    // ---------- Projects showcase ----------
    let activeTag = "All";
    function renderProjects(){
      const q = ""; 
      const list = (state.config.projects || []).filter(p => {
        const tagOK = (activeTag === "All") || (p.tags || []).includes(activeTag);
        const qOK = !q || ((p.title||"") + " " + (p.desc||"") + " " + (p.tags||[]).join(" ")).toLowerCase().includes(q);
        return tagOK && qOK;
      });

      el.projCards.innerHTML = list.map(p => `
        <div class="projCard">
          <div class="inner">
            <h3>${escapeHtml(p.title || "")}</h3>
            <p>${escapeHtml(p.desc || "")}</p>
            <div class="tags">${(p.tags || []).map(tg => `<span class="tag">${escapeHtml(tg)}</span>`).join("")}</div>
            <div class="actions">
              <button class="linkBtn" data-url="${escapeHtml(p.url || "#")}">${escapeHtml(p.cta || "Open")}</button>
              <span class="small">• Premium showcase</span>
            </div>
          </div>
        </div>
      `).join("");

      $$(".linkBtn", el.projCards).forEach(btn => {
        btn.addEventListener("click", () => safeOpen(btn.dataset.url));
      });
    }

    // ---------- Services UI ----------
    function thumbSvg(emoji){
      const a1 = "rgba(139,92,246,.45)";
      const a2 = "rgba(34,211,238,.25)";
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="${a1}"/>
              <stop offset="1" stop-color="${a2}"/>
            </linearGradient>
          </defs>
          <rect width="256" height="256" rx="44" fill="url(#g)"/>
          <circle cx="188" cy="70" r="64" fill="rgba(255,255,255,.08)"/>
          <circle cx="58" cy="206" r="74" fill="rgba(0,0,0,.18)"/>
          <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle"
                font-size="110" font-family="Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji">${emoji||"🍽️"}</text>
          <text x="50%" y="86%" dominant-baseline="middle" text-anchor="middle"
                font-size="18" fill="rgba(255,255,255,.75)" font-family="${fontMono}">IN-FLIGHT</text>
        </svg>
      `.trim();
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    let order = loadOrder();
    let modalItem = null;
    let modalQty = 1;

    function setStepper(step){
      $$("#entStepper .step").forEach(s => s.classList.toggle("on", s.dataset.step === String(step)));
    }

    function syncOrderUI(){
      order = loadOrder();
      const { sum, qty } = orderTotals(order);
      el.entCartCount.textContent = String(qty);
      el.entSeatMini.textContent = `SEAT: ${seatKey()}`;

    const label =
      order.status === "sent" ? (state.lang==="vi" ? "ĐÃ GỬI" : "SENT") :
      order.status === "confirmed" ? (state.lang==="vi" ? "ĐÃ XÁC NHẬN" : "CONFIRMED") :
      (state.lang==="vi" ? "NHÁP" : "DRAFT");
      el.orderStateVal.textContent = label;

      el.orderStateSub.innerHTML = [
        `Ghế: <b>${escapeHtml(seatKey())}</b>`,
        `Giỏ: <b>${qty}</b> • <b>${escapeHtml(fmtMoney(sum))}</b>`,
        `<span class="mono">${escapeHtml(order.updatedAt || "")}</span>`
      ].join("<br/>");

      el.orderNote.value = order.note || "";

      if(order.status === "draft") setStepper(1);
      if(order.status === "confirmed") setStepper(2);
      if(order.status === "sent") setStepper(3);
    }

    function renderSvcPills(){
      const cats = state.config.services?.categories || SERVICES_DEFAULT.categories;
      el.svcPills.innerHTML = cats.map(c => {
        const on = c.id === state.svcCat;
        return `<button class="fp" aria-pressed="${on}" data-cat="${escapeHtml(c.id)}">${escapeHtml(c.icon)} ${escapeHtml(pickLang(c.name))}</button>`;
      }).join("");
      $$(".fp", el.svcPills).forEach(b => {
        b.addEventListener("click", () => {
          state.svcCat = b.dataset.cat;
          renderSvcPills();
          renderSvcGrid();
        });
      });

      const current = cats.find(x => x.id === state.svcCat);
      el.svcActive.textContent = current ? pickLang(current.name).toUpperCase() : "—";
    }

    function renderSvcGrid(){
      const items = state.config.services?.items || SERVICES_DEFAULT.items;
      const cats = state.config.services?.categories || SERVICES_DEFAULT.categories;
      const q = (el.svcSearch.value || "").trim().toLowerCase();

      const current = cats.find(x => x.id === state.svcCat);
      el.entCatTitle.textContent = current ? pickLang(current.name) : "—";
      el.entCatHint.textContent = state.lang === "vi"
        ? "Chọn món → xem chi tiết → thêm vào giỏ"
        : "Tap item → details → add to cart";

      const list = items.filter(it => {
        if(it.cat !== state.svcCat) return false;
        const text = (pickLang(it.name) + " " + pickLang(it.desc) + " " + (it.allergens||[]).join(" ")).toLowerCase();
        return !q || text.includes(q);
      });

      el.svcGrid.innerHTML = list.map(it => `
        <div class="svcCard" tabindex="0" data-id="${escapeHtml(it.id)}">
          <div class="svcInner">
            <div class="svcThumb"><img alt="thumb" src="${thumbSvg(it.emoji)}"></div>
            <div style="flex:1; min-width:0">
              <h3 class="svcName">${escapeHtml(pickLang(it.name))}</h3>
              <div class="svcDesc">${escapeHtml(pickLang(it.desc))}</div>
              <div class="svcMeta">
                <span class="svcPill">${escapeHtml(fmtMoney(it.priceVnd))}</span>
                <span class="svcPill">${escapeHtml(String(it.kcal||0))} kcal</span>
                ${(it.allergens||[]).slice(0,2).map(a=>`<span class="svcPill">${escapeHtml(a)}</span>`).join("")}
              </div>
            </div>
          </div>
        </div>
      `).join("");

      $$(".svcCard", el.svcGrid).forEach(card => {
        const open = () => openSvcModal(card.dataset.id);
        card.addEventListener("click", open);
        card.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); open(); } });
      });
    }

    function openSvcModal(id){
      const items = state.config.services?.items || SERVICES_DEFAULT.items;
      const it = items.find(x => x.id === id);
      if(!it) return;

      modalItem = it;
      modalQty = 1;

      el.svcSeat.textContent = seatKey();
      el.qtyVal.textContent = String(modalQty);
      el.svcItemNote.value = "";

      el.svcImg.src = thumbSvg(it.emoji);
      el.svcName.textContent = pickLang(it.name);
      el.svcDesc.textContent = pickLang(it.desc);

      el.svcTags.innerHTML = [
        `<span class="tag">${escapeHtml(fmtMoney(it.priceVnd))}</span>`,
        `<span class="tag">${escapeHtml(String(it.kcal||0))} kcal</span>`,
        ...(it.allergens||[]).map(a=>`<span class="tag">${escapeHtml(a)}</span>`)
      ].join("");

      el.svcExtra.innerHTML = `
        <b>Thông tin:</b><br/>
        • Danh mục: <span class="mono">${escapeHtml(it.cat)}</span><br/>
        • Giá: <span class="mono">${escapeHtml(fmtMoney(it.priceVnd))}</span><br/>
        • Số lượng: <span class="mono" id="svcExtraQty">${modalQty}</span><br/>
        <div class="hr"></div>
        <b>Gợi ý:</b> nếu có dị ứng thực phẩm, hãy báo tiếp viên trước khi dùng.
      `;

      showSvcModal(true);
      pushLog("svc_open", { id });
    }

    function showSvcModal(on){
      el.svcMask.classList.toggle("show", !!on);
      el.svcMask.setAttribute("aria-hidden", on ? "false" : "true");
    }

    function addToCart(item, qty, note){
      order = loadOrder();
      const idx = (order.items||[]).findIndex(x => x.id === item.id);
      if(idx >= 0){
        order.items[idx].qty += qty;
        if(note && note.trim()) order.items[idx].note = note.trim();
      }else{
        order.items.push({
          id: item.id,
          name: pickLang(item.name),
          priceVnd: item.priceVnd,
          qty,
          note: (note||"").trim()
        });
      }
      order.status = "draft";
      saveOrder(order);
      syncOrderUI();
      toast("Đã thêm vào giỏ");
      pushLog("cart_add", { id:item.id, qty });
    }

    function showCartToast(){
      order = loadOrder();
      const { sum, qty } = orderTotals(order);
      if(qty === 0){
        toast("Chưa có món nào.");
        return;
      }
      const lines = order.items.slice(0, 6).map(it => `${it.qty}× ${it.name}`).join(" • ");
      toast(`${qty} món • ${fmtMoney(sum)} • ${lines}`);
    }

    // ---------- Apps ----------
    function renderApps(){
      const apps = state.config.apps || [];
      el.appGrid.innerHTML = apps.map(a => `
        <button class="appTile" data-url="${escapeHtml(a.url || "#")}">
          <div class="name">${escapeHtml(a.name || "")}</div>
          <div class="desc">${escapeHtml(a.desc || "")}</div>
          <div class="mini">${escapeHtml(a.hint || "")}</div>
        </button>
      `).join("");
      $$(".appTile", el.appGrid).forEach(tile => {
        tile.addEventListener("click", () => safeOpen(tile.dataset.url));
      });
    }

    // ---------- Media library ----------
    function renderMedia(){
      const lib = state.config.ife?.library || [];
      el.mediaCount.textContent = String(lib.length);
      el.mediaBtns.innerHTML = lib.slice(0, 10).map((m,i) => `
        <button class="btn" data-i="${i}">▶ ${escapeHtml(pickLang(m.title) || ("Media " + (i+1)))}</button>
      `).join("");

      $$(".btn", el.mediaBtns).forEach(b => {
        b.addEventListener("click", () => {
          const idx = parseInt(b.dataset.i, 10);
          const item = lib[idx];
          if(!item?.url){
            toast("Media URL thiếu trong CMS.");
            pushLog("media_blocked", { idx, reason:"missing_url" });
            return;
          }
          if(/^https?:\/\//i.test(item.url)){
            const host = normalizeHost(item.url);
            if(!hostAllowed(host, state.config.whitelist || [])){
              toast("Media bị chặn bởi whitelist.");
              pushLog("media_blocked", { idx, url:item.url, host, reason:"not_in_whitelist" });
              return;
            }
          }
          el.ifeMode.textContent = "URL";
          el.video.src = item.url;
          el.video.play().catch(()=>{});
          toast((state.lang==="vi" ? "Đang phát: " : "Playing: ") + (pickLang(item.title)||"Media"));
          pushLog("media_play", { idx, title: pickLang(item.title), url:item.url });
        });
      });
    }

    // ---------- Video (local) ----------
    function loadVideoFile(file){
      if (state.currentVideoBlob) {
        URL.revokeObjectURL(state.currentVideoBlob);
      }
      const url = URL.createObjectURL(file);
      state.currentVideoBlob = url; 

      el.ifeMode.textContent = "LOCAL";
      el.video.src = url;
      el.video.play().catch(()=>{});
      toast(`Loaded: ${file.name}`);
      pushLog("video_local_loaded", { name:file.name, size:file.size });
    }
    
    function wireVideo(){
      el.btnPickVideo.addEventListener("click", () => el.fileVideo.click());
      el.fileVideo.addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        loadVideoFile(f);
      });

      el.btnStopVideo.addEventListener("click", () => {
        el.video.pause();
        el.video.removeAttribute("src");
        el.video.load();
        
        if(state.currentVideoBlob) {
          URL.revokeObjectURL(state.currentVideoBlob);
          state.currentVideoBlob = null;
        }
        
        toast("Stopped");
        pushLog("video_stop", {});
      });

      el.drop.addEventListener("dragover", (e) => { e.preventDefault(); el.drop.style.background = "rgba(255,255,255,.06)"; });
      el.drop.addEventListener("dragleave", () => { el.drop.style.background = "rgba(0,0,0,.18)"; });
      el.drop.addEventListener("drop", (e) => {
        e.preventDefault();
        el.drop.style.background = "rgba(0,0,0,.18)";
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if(f) loadVideoFile(f);
      });
    }

    // ---------- Settings modal ----------
    function showSettings(on){
      el.modalMask.classList.toggle("show", !!on);
      el.modalMask.setAttribute("aria-hidden", on ? "false" : "true");
      if(on){
        el.seatIdInput.value = state.seat.id === "—" ? "" : state.seat.id;
        el.profileInput.value = state.seat.profile || "adult";
        el.langInput.value = state.lang;

        el.brandTitleInput.value = state.config.brand?.title || "";
        el.brandSubInput.value = state.config.brand?.subtitle || "";
        el.whitelistInput.value = (state.config.whitelist || []).join("\n");

        refreshExport();
        refreshLogs();
      }
    }
    function setPane(p){
      const panes = { seat: el.paneSeat, cms: el.paneCMS, security: el.paneSecurity, logs: el.paneLogs };
      Object.entries(panes).forEach(([k,node]) => node.style.display = (k === p) ? "block" : "none");
      el.navItems.forEach(b => b.setAttribute("aria-pressed", b.dataset.pane === p ? "true" : "false"));
    }
    function refreshExport(){ el.configPreview.value = JSON.stringify(state.config, null, 2); }
    function refreshLogs(){
      const logs = getLogs();
      el.logsBox.value = logs.map(x => `[${x.t}] ${x.type} ${JSON.stringify(x.meta)}`).join("\n");
    }

    // ---------- Wiring ----------
    function wireUI(){
      // Tabs
      el.tabBtns.forEach(b => b.addEventListener("click", () => setTab(b.dataset.tab)));
      window.addEventListener("hashchange", initHash);

      // Safety mode
      el.modeAlt.addEventListener("click", () => setMode("alt"));
      el.modePress.addEventListener("click", () => setMode("press"));

      // Sliders -> manual
      el.altRange.addEventListener("input", () => {
        if(state.mode !== "alt") return;
        setSim("manual");
        syncFromAltitude(parseFloat(el.altRange.value));
        renderSafety();
      });
      el.pressRange.addEventListener("input", () => {
        if(state.mode !== "press") return;
        setSim("manual");
        syncFromPressure(parseFloat(el.pressRange.value));
        renderSafety();
      });

      // Sim toggle
      el.btnSim.addEventListener("click", () => {
        const next = (state.sim === "auto") ? "manual" : "auto";

        if (next === "auto") {
          // ✅ start auto from current value
          setAutoT0FromCurrent();
          setSim("auto");
          toast("AUTO: ON");
        } else {
          setSim("manual");
          toast("AUTO: OFF");
        }

        // make sure state matches UI immediately
        if (state.mode === "alt") syncFromAltitude(parseFloat(el.altRange.value));
        else syncFromPressure(parseFloat(el.pressRange.value));

        renderSafety();
      });

      // Pause
      el.btnPause.addEventListener("click", () => {
        state.paused = !state.paused;
        el.btnPause.textContent = state.paused ? (state.lang==="vi"?"Tiếp tục":"Resume") : (state.lang==="vi"?"Tạm dừng":"Pause");
        toast(state.paused ? "Paused" : "Resumed");
        pushLog("pause_toggle", { paused: state.paused });
      });

      // Reset
      el.btnReset.addEventListener("click", () => {
state.paused = false;
                state.t = 0;
        state.autoT0 = 0;
state.alertTest = false;
        state.calm = false;
        setMode("alt");
        setSim("auto");
        el.altRange.value = 2400;
        el.pressRange.value = 750;
        syncFromAltitude(2400);
        if(typeof setAutoT0FromCurrent === "function") setAutoT0FromCurrent();
el.btnPause.textContent = state.lang==="vi" ? "Tạm dừng" : "Pause";
        toast("Reset");
        pushLog("reset", {});
        renderSafety();
      });
// Language toggle
      el.btnLang.addEventListener("click", () => {
        state.lang = (state.lang === "vi") ? "en" : "vi";
        applyLang();
        applyTheme();
        saveSeat();
        toast(state.lang==="vi" ? "Đã chuyển VI" : "Switched to EN");
      });

      // Theme toggle
      if(el.btnTheme){
        el.btnTheme.addEventListener("click", () => {
          state.theme = (state.theme === "light") ? "dark" : "light";
          applyTheme();
          saveSeat();
          toast(state.theme === "light" ? "Giao diện: LIGHT" : "Giao diện: DARK");
        });
      }

      // Overlay collapse
      el.ovToggle.addEventListener("click", () => {
        el.overlay.classList.toggle("min");
        el.ovToggle.textContent = el.overlay.classList.contains("min") ? "▸" : "▾";
        pushLog("overlay_toggle", { min: el.overlay.classList.contains("min") });
      });

      // Services search (Debounced)
      el.btnClearSvcSearch.addEventListener("click", () => { el.svcSearch.value=""; renderSvcGrid(); });
      el.svcSearch.addEventListener("input", debounce(renderSvcGrid, 250));

      // Menu / Showcase seg
      el.entBtnMenu.addEventListener("click", () => {
        el.entBtnMenu.setAttribute("aria-pressed","true");
        el.entBtnShowcase.setAttribute("aria-pressed","false");
        el.menuWrap.style.display = "block";
        el.showcaseWrap.style.display = "none";
      });
      el.entBtnShowcase.addEventListener("click", () => {
        el.entBtnMenu.setAttribute("aria-pressed","false");
        el.entBtnShowcase.setAttribute("aria-pressed","true");
        el.menuWrap.style.display = "none";
        el.showcaseWrap.style.display = "block";
      });

      // Cart quick view
      el.entCartBtn.addEventListener("click", showCartToast);
      el.btnViewCart.addEventListener("click", showCartToast);

      // Order note
      el.orderNote.addEventListener("input", () => {
        order = loadOrder();
        order.note = el.orderNote.value || "";
        saveOrder(order);
        syncOrderUI();
      });

      // Confirm / Send / Clear
      el.btnConfirmOrder.addEventListener("click", () => {
        order = loadOrder();
        if((order.items||[]).length === 0){
          toast("Giỏ trống.");
          return;
        }
        order.status = "confirmed";
        saveOrder(order);
        syncOrderUI();
        toast("Đã xác nhận");
        pushLog("order_confirmed", { seat: seatKey() });
      });

      el.btnSendOrder.addEventListener("click", () => {
        order = loadOrder();
        if((order.items||[]).length === 0){
          toast("Giỏ trống.");
          return;
        }
        if(order.status !== "confirmed"){
          toast("Hãy bấm “Xác nhận” trước.");
          return;
        }
        order.status = "sent";
        saveOrder(order);
        syncOrderUI();
        toast("Đã gửi (mô phỏng)");
        pushLog("order_sent", { seat: seatKey(), items: order.items.length });
      });

      el.btnClearOrder.addEventListener("click", () => {
        const all = getAllOrders();
        delete all[seatKey()];
        saveAllOrders(all);
        syncOrderUI();
        toast("Đã xóa đơn");
        pushLog("order_cleared", { seat: seatKey() });
      });

      // Service modal
      el.svcClose.addEventListener("click", () => showSvcModal(false));
      el.svcMask.addEventListener("click", (e)=>{ if(e.target === el.svcMask) showSvcModal(false); });

      el.qtyMinus.addEventListener("click", () => {
        modalQty = Math.max(1, modalQty - 1);
        el.qtyVal.textContent = String(modalQty);
        const qn = $("#svcExtraQty");
        if(qn) qn.textContent = String(modalQty);
      });
      el.qtyPlus.addEventListener("click", () => {
        modalQty = Math.min(12, modalQty + 1);
        el.qtyVal.textContent = String(modalQty);
        const qn = $("#svcExtraQty");
        if(qn) qn.textContent = String(modalQty);
      });

      el.svcAdd.addEventListener("click", () => {
        if(!modalItem) return;
        addToCart(modalItem, modalQty, el.svcItemNote.value || "");
        showSvcModal(false);
      });
      el.svcViewCart.addEventListener("click", () => {
        showSvcModal(false);
        showCartToast();
      });

      // Video
      wireVideo();

      // Settings
      el.btnSettings.addEventListener("click", () => {
        const unlocked = state.isAdmin || sessionStorage.getItem("aero.admin")==="1";
        if(unlocked){
          state.isAdmin = true;
          showSettings(true);
        }else{
          showAdminLogin(() => showSettings(true));
        }
      });
el.btnCloseSettings.addEventListener("click", () => showSettings(false));
      el.modalMask.addEventListener("click", (e) => { if(e.target === el.modalMask) showSettings(false); });
      el.navItems.forEach(b => b.addEventListener("click", () => setPane(b.dataset.pane)));

      // Seat save/reset
      el.btnSaveSeat.addEventListener("click", () => {
        state.seat.id = (el.seatIdInput.value || "").trim() || "—";
        state.seat.profile = el.profileInput.value || "adult";
        state.lang = el.langInput.value || "vi";
        applySeatUI();
        applyLang();
        saveSeat();
        syncOrderUI();
        toast("Đã lưu ghế");
      });
      el.btnResetSeat.addEventListener("click", () => {
        state.seat = { id:"—", profile:"adult" };
        state.lang = "vi";
        applySeatUI();
        applyLang();
        saveSeat();
        syncOrderUI();
        toast("Đã reset ghế");
      });

      // CMS import 
      el.configFile.addEventListener("change", async (e) => {
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        try{
          const txt = await f.text(); 
          const incoming = JSON.parse(txt);
          state.config = mergeConfig(structuredCloneSafe(FACTORY), incoming);
          saveConfig(state.config);
          applyBrand();
          renderProjects();
          renderApps();
          renderMedia();
          renderSvcPills();
          renderSvcGrid();
          el.brandTitleInput.value = state.config.brand?.title || "";
          el.brandSubInput.value = state.config.brand?.subtitle || "";
          el.whitelistInput.value = (state.config.whitelist || []).join("\n");
          refreshExport();
          toast("Đã import config");
          pushLog("config_import", { name: f.name, size: f.size });
        }catch(err){
          toast("Import thất bại (JSON lỗi).");
          pushLog("config_import_failed", { err: String(err) });
        }finally{
          e.target.value = "";
        }
      });

      // Apply brand
      el.btnApplyBrand.addEventListener("click", () => {
        state.config.brand = state.config.brand || {};
        state.config.brand.title = (el.brandTitleInput.value || "").trim() || FACTORY.brand.title;
        state.config.brand.subtitle = (el.brandSubInput.value || "").trim() || FACTORY.brand.subtitle;
        saveConfig(state.config);
        applyBrand();
        refreshExport();
        toast("Đã áp dụng brand");
      });

      el.btnExport.addEventListener("click", () => { refreshExport(); toast("Đã làm mới export"); });

      el.btnFactory.addEventListener("click", () => {
        state.config = structuredCloneSafe(FACTORY);
        saveConfig(state.config);
        applyBrand();
        renderProjects();
        renderApps();
        renderMedia();
        renderSvcPills();
        renderSvcGrid();
        el.brandTitleInput.value = state.config.brand.title;
        el.brandSubInput.value = state.config.brand.subtitle;
        el.whitelistInput.value = (state.config.whitelist || []).join("\n");
        refreshExport();
        toast("Đã khôi phục mặc định");
        pushLog("factory_defaults", {});
      });

      // Whitelist save
      el.btnSaveWhitelist.addEventListener("click", () => {
        const list = (el.whitelistInput.value || "")
          .split("\n").map(x => x.trim()).filter(Boolean);
        state.config.whitelist = Array.from(new Set(list));
        if(!state.config.whitelist.includes("upload.wikimedia.org")) state.config.whitelist.push("upload.wikimedia.org");
        saveConfig(state.config);
        refreshExport();
        toast("Đã lưu whitelist");
        pushLog("whitelist_saved", { count: state.config.whitelist.length });
      });

      el.btnTighten.addEventListener("click", () => {
        state.config.whitelist = ["intranet.airline.local"];
        el.whitelistInput.value = state.config.whitelist.join("\n");
        saveConfig(state.config);
        refreshExport();
        toast("Đã siết whitelist");
        pushLog("whitelist_tighten", {});
      });

      // Logs
      el.btnRefreshLogs.addEventListener("click", () => { refreshLogs(); toast("Đã làm mới log"); });
      el.btnClearLogs.addEventListener("click", () => {
        localStorage.setItem(KEY.logs, "[]");
        refreshLogs();
        toast("Đã xóa log");
      });
      el.btnCopyLogs.addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(el.logsBox.value || "");
          toast("Copied");
        }catch{
          toast("Copy failed");
        }
      });

      // ESC closes modals
      window.addEventListener("keydown", (e) => {
        if(e.key === "Escape"){
          if(el.modalMask.classList.contains("show")) showSettings(false);
          if(el.svcMask.classList.contains("show")) showSvcModal(false);
        }
      });
    }

    // ---------- Boot ----------
    function initSeatAndLang(){
      applyTheme();
      loadSeat();
      applySeatUI();
      applyLang();
      el.profileInput.value = state.seat.profile || "adult";
      el.langInput.value = state.lang;
    }

    function boot(){
      applyTheme();
      initHash();
      initSeatAndLang();
      applyBrand();

      // init safety
      setMode("alt");
      setSim("auto");
      syncFromAltitude(state.cabinAlt_m);

      // canvas
      DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      resizeCanvas();

      // views
      renderProjects();
      renderApps();
      renderMedia();
      renderSvcPills();
      renderSvcGrid();
      syncOrderUI();

      // wire
      wireUI();

      // clock
      updateClock();
      setInterval(updateClock, 1000);

      // loop
      requestAnimationFrame(loop);
      pushLog("boot", { v: "3" });
    }

    let last = performance.now();
    function loop(now){
      const dt = now - last;
      last = now;

      tick(dt);
      renderSafety();
      draw();

      requestAnimationFrame(loop);
    }

    boot();
  </script>
<div class="modalPane" style="padding:20px">
      <div class="field" style="grid-template-columns:1fr">
        <label style="margin-bottom:6px">Enter password</label>
        <input type="password" id="adminPass" placeholder="••••••" />
      </div>
      <div id="adminError" style="color:#fb7185;font-size:12px;margin-top:8px;display:none">
        Invalid password
      </div>
      <div class="inlineBtns" style="margin-top:14px">
        <button class="btn" id="adminCancel">Cancel</button>
        <button class="btn primary" id="adminUnlock">Unlock</button>
      </div>
    </div>
  </div>
</div>


  <!-- ADMIN LOGIN MODAL (Injected) -->
  <div class="modalMask" id="adminMask" aria-hidden="true" style="z-index:10000">
    <div class="modal" role="dialog" aria-modal="true" style="width:min(520px,96vw);height:auto;max-height:92vh">
      <div class="modalTop">
        <h3 id="adminTitle" style="margin:0;letter-spacing:.18em;text-transform:uppercase;font-size:13px">Admin Access</h3>
        <div class="right">
          <button class="btn" id="adminCloseBtn" title="Close">Đóng</button>
        </div>
      </div>

      <div class="modalPane" style="padding:16px 16px 18px">
        <div class="mutedBox" id="adminHint" style="margin-bottom:12px">
          <b>Restricted</b>: CMS / Whitelist / Logs are for crew/admin only.
        </div>

        <div class="field" style="grid-template-columns:1fr;gap:8px">
          <label id="adminPassLabel" style="margin:0">Password</label>
          <input id="adminPassInput" type="password" placeholder="••••" autocomplete="off" />
        </div>

        <div id="adminError" class="mutedBox" style="margin-top:10px;border-color:rgba(251,113,133,.35);color:rgba(251,113,133,.95);display:none">
          Invalid password.
        </div>

        <div class="inlineBtns" style="margin-top:14px">
          <button class="btn" id="adminCancelBtn">Hủy</button>
          <button class="btn primary" id="adminUnlockBtn">Mở khóa</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
